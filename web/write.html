<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>write</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; line-height: 1.35; }
    header { padding: 14px 16px; border-bottom: 1px solid color-mix(in oklab, currentColor 22%, transparent); display:flex; align-items:baseline; justify-content:space-between; gap: 12px; }
    h1 { font-size: 18px; margin: 0; }
    main { max-width: 74rem; margin: 0 auto; padding: 16px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .pill { display:inline-block; border: 1px solid color-mix(in oklab, currentColor 60%, transparent); border-radius: 999px; padding: 2px 10px; font-size: 12px; }
    .muted { opacity: .75; }
    .card { border: 1px solid color-mix(in oklab, currentColor 18%, transparent); border-radius: 14px; padding: 12px; margin: 12px 0; }
    button { font: inherit; padding: 8px 10px; border-radius: 10px; border: 1px solid color-mix(in oklab, currentColor 30%, transparent); background: transparent; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    textarea, input, select { font: inherit; padding: 8px 10px; border-radius: 10px; border: 1px solid color-mix(in oklab, currentColor 30%, transparent); background: transparent; }
    textarea { width: 100%; min-height: 110px; resize: vertical; }
    .entry { padding: 12px; border-radius: 14px; border: 1px solid color-mix(in oklab, currentColor 18%, transparent); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .stars { margin-top: 10px; padding-top: 10px; border-top: 1px dashed color-mix(in oklab, currentColor 22%, transparent); }
    .star { padding: 10px; border-radius: 12px; border: 1px solid color-mix(in oklab, currentColor 18%, transparent); margin-top: 8px; }
    .startext {
      width: 100%;
      min-height: 90px;
      resize: vertical;
    }
    .two { display:grid; grid-template-columns: 220px 1fr; gap: 10px; }
    @media (max-width: 720px) { .two { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<header>
  <div class="row">
    <h1>write</h1>
    <span class="pill" id="adminPill">admin: …</span>
  </div>
  <div class="row">
    <button id="setKeyBtn" type="button">set admin key</button>
    <button id="clearKeyBtn" type="button">clear key</button>
    <button id="refreshBtn" type="button">refresh</button>
    <button id="showAllBtn" type="button" style="display:none;">show all</button>
  </div>
</header>

<main>
  <section class="card" id="lockedCard">
    <div class="row" style="justify-content:space-between;">
      <strong>locked</strong>
      <span class="muted">This page is admin-protected.</span>
    </div>
    <div class="muted" style="margin-top:8px;">
      Set <span class="mono">localStorage.lang_admin_key</span> to unlock.
    </div>
  </section>

  <section class="card" id="composerCard" style="display:none;">
    <div class="row" style="justify-content:space-between;">
      <strong>new lang entry</strong>
      <span class="muted" id="meta">…</span>
    </div>
    <div style="margin-top:10px;">
      <textarea id="textInput" placeholder="type text…"></textarea>
    </div>
    <div class="row" style="margin-top:10px; justify-content:space-between;">
      <div class="row">
        <button id="createBtn" type="button">create</button>
        <button id="clearBtn" type="button">clear</button>
      </div>
      <span class="muted" id="status"></span>
    </div>
  </section>

  <section class="card" id="listCard" style="display:none;">
    <div class="row" style="justify-content:space-between;">
      <strong>entries</strong>
      <span class="muted" id="listMeta">…</span>
    </div>
    <div id="listHost" style="margin-top:10px;"></div>
  </section>
</main>

<script>
  const $ = (id) => document.getElementById(id);

  let focusedLangId = null;

  function setFocus(id) {
    focusedLangId = id ? String(id) : null;
    const url = new URL(window.location.href);
    if (focusedLangId) url.searchParams.set("focus", focusedLangId);
    else url.searchParams.delete("focus");
    window.history.replaceState({}, "", url.toString());
    $("showAllBtn").style.display = focusedLangId ? "" : "none";
  }

  function readFocusFromUrl() {
    const url = new URL(window.location.href);
    const f = url.searchParams.get("focus");
    focusedLangId = f ? String(f) : null;
    $("showAllBtn").style.display = focusedLangId ? "" : "none";
  }

  function getAdminKey() { return localStorage.getItem("lang_admin_key") || ""; }
  function setAdminKey(v) { localStorage.setItem("lang_admin_key", v); }
  function clearAdminKey() { localStorage.removeItem("lang_admin_key"); }

  function withAdminHeaders(h = {}) {
    const k = getAdminKey();
    if (k) h["X-Admin-Key"] = k;
    return h;
  }

  async function apiGet(url, { admin = false } = {}) {
    const headers = { "Accept": "application/json" };
    if (admin) Object.assign(headers, withAdminHeaders());
    const res = await fetch(url, { headers });
    if (!res.ok) throw new Error(`GET ${url} failed (${res.status})`);
    return await res.json();
  }

  async function apiJson(method, url, body, { admin = false } = {}) {
    const headers = { "Accept": "application/json", "Content-Type": "application/json" };
    if (admin) Object.assign(headers, withAdminHeaders());
    const res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : undefined });
    const txt = await res.text();
    let data = null;
    try { data = txt ? JSON.parse(txt) : null; } catch {}
    if (!res.ok) {
      const msg = (data && (data.description || data.error)) || `${method} ${url} failed (${res.status})`;
      throw new Error(msg);
    }
    return data;
  }

  const apiPost = (url, body, opts) => apiJson("POST", url, body, opts);
  const apiDelete = (url, opts) => apiJson("DELETE", url, null, opts);

  function esc(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function countStars(nodes) {
    let count = 0;
    for (const node of nodes) {
      count += 1;
      if (Array.isArray(node.children) && node.children.length) {
        count += countStars(node.children);
      }
    }
    return count;
  }

  function renderStar(node, depth) {
    const texts = Array.isArray(node.texts) ? node.texts : [];
    const children = Array.isArray(node.children) ? node.children : [];
    const textHtml = texts.map(t => `
      <div style="margin-top:8px; white-space:pre-wrap;">${esc(t.text)}</div>
    `).join("") || `<div class="muted">no texts yet</div>`;
    const childrenHtml = children.map(c => renderStar(c, depth + 1)).join("");

    return `
      <div class="star" style="margin-left:${depth * 18}px;">
        <div class="row" style="justify-content:space-between;">
          <div class="muted mono">★ #${esc(node.id)} • ${esc(node.type)} • ${esc(node.updated_at || node.created_at || "")}</div>
          <button data-del-star="${esc(node.id)}" type="button">delete branch</button>
        </div>
        ${textHtml}
        <div style="margin-top:8px;">
          <textarea class="startext" placeholder="append text…" data-append-text="${esc(node.id)}"></textarea>
          <div class="row" style="margin-top:6px;">
            <button data-append-star="${esc(node.id)}" type="button">append text</button>
            <span class="muted" data-append-status="${esc(node.id)}"></span>
          </div>
        </div>
        <div style="margin-top:10px;">
          <div class="two">
            <input placeholder="child type (e.g. note, prompt, tag)" data-child-type="${esc(node.id)}" />
            <textarea class="startext" placeholder="child text…" data-child-text="${esc(node.id)}"></textarea>
          </div>
          <div class="row" style="margin-top:6px;">
            <button data-add-child-star="${esc(node.id)}" data-lang-id="${esc(node.lang_id)}" type="button">add child star</button>
            <span class="muted" data-child-status="${esc(node.id)}"></span>
          </div>
        </div>
        ${childrenHtml ? `<div style="margin-top:10px;">${childrenHtml}</div>` : ""}
      </div>
    `;
  }

  async function loadStarTree(langId, hostEl, countEl) {
    hostEl.innerHTML = `<div class="muted">loading…</div>`;
    try {
      const data = await apiGet(`/api/lang/${encodeURIComponent(langId)}/stars/tree`);
      const stars = Array.isArray(data.stars) ? data.stars : [];
      if (countEl) countEl.textContent = `${countStars(stars)} items`;
      hostEl.innerHTML = stars.map(s => renderStar(s, 0)).join("") || `<div class="muted">no star stuff yet</div>`;
    } catch (e) {
      hostEl.innerHTML = `<div class="muted">failed to load stars</div>`;
    }
  }

  async function refreshAdmin() {
    const k = getAdminKey();
    if (!k) {
      $("adminPill").textContent = "admin: no key";
      $("lockedCard").style.display = "";
      $("composerCard").style.display = "none";
      $("listCard").style.display = "none";
      return false;
    }
    try {
      await apiGet("/api/admin/ping", { admin: true });
      $("adminPill").textContent = "admin: ok";
      $("lockedCard").style.display = "none";
      $("composerCard").style.display = "";
      $("listCard").style.display = "";
      return true;
    } catch {
      $("adminPill").textContent = "admin: invalid";
      $("lockedCard").style.display = "";
      $("composerCard").style.display = "none";
      $("listCard").style.display = "none";
      return false;
    }
  }

  async function loadEntries() {
    $("listHost").innerHTML = `<div class="muted">loading…</div>`;
    const data = await apiGet("/api/lang?include_stars=0");
    let entries = Array.isArray(data.entries) ? data.entries : [];
    const allEntries = entries;

    if (focusedLangId) {
      entries = allEntries.filter(e => String(e.id) === String(focusedLangId));
    }

    $("listMeta").textContent = focusedLangId
      ? `focused: #${focusedLangId}`
      : `${entries.length} shown`;
    $("composerCard").style.display = focusedLangId ? "none" : "";

    $("listHost").innerHTML = "";
    for (const e of entries) {
      const div = document.createElement("div");
      div.className = "entry";
      div.style.marginTop = "10px";

      div.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div class="muted mono">#${esc(e.id)} • ${esc(e.updated_at || e.created_at || "")}</div>
          <div class="row">
            <button data-focus-lang="${esc(e.id)}" type="button">focus</button>
            <button data-del-lang="${esc(e.id)}" type="button">delete entry</button>
          </div>
        </div>

        <div style="margin-top:8px; white-space:pre-wrap;">${esc(e.text)}</div>

        <div class="stars">
          <div class="row" style="justify-content:space-between;">
            <strong>star stuff</strong>
            <span class="muted" data-star-count="${esc(e.id)}">…</span>
          </div>

          <div class="two" style="margin-top:10px;">
            <input placeholder="root type (e.g. note, prompt, tag)" data-root-star-type="${esc(e.id)}" />
            <textarea class="startext" placeholder="root text…" data-root-star-text="${esc(e.id)}"></textarea>
          </div>
          <div class="row" style="margin-top:10px;">
            <button data-add-root-star="${esc(e.id)}" type="button">add root star</button>
            <span class="muted" data-root-star-status="${esc(e.id)}"></span>
          </div>

          <div data-stars-host="${esc(e.id)}" style="margin-top:10px;"></div>
        </div>
      `;

      $("listHost").appendChild(div);

      const host = div.querySelector(`[data-stars-host="${CSS.escape(String(e.id))}"]`);
      const countEl = div.querySelector(`[data-star-count="${CSS.escape(String(e.id))}"]`);
      await loadStarTree(e.id, host, countEl);
    }

    // wire lang deletes
    for (const btn of document.querySelectorAll("button[data-del-lang]")) {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-del-lang");
        if (!id) return;
        if (!confirm(`Delete lang entry #${id} (and all its star stuff)?`)) return;
        try {
          await apiDelete(`/api/lang/${encodeURIComponent(id)}`, { admin: true });
          await loadEntries();
        } catch (e) {
          alert(e.message || String(e));
        }
      });
    }

    // wire star deletes
    for (const btn of document.querySelectorAll("button[data-del-star]")) {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-del-star");
        if (!id) return;
        if (!confirm(`Delete star branch #${id} (and all children)?`)) return;
        try {
          await apiDelete(`/api/stars/${encodeURIComponent(id)}`, { admin: true });
          await loadEntries();
        } catch (e) {
          alert(e.message || String(e));
        }
      });
    }

    // wire add root star
    for (const btn of document.querySelectorAll("button[data-add-root-star]")) {
      btn.addEventListener("click", async () => {
        const langId = btn.getAttribute("data-add-root-star");
        if (!langId) return;

        const typeEl = document.querySelector(`[data-root-star-type="${CSS.escape(String(langId))}"]`);
        const textEl = document.querySelector(`[data-root-star-text="${CSS.escape(String(langId))}"]`);
        const statusEl = document.querySelector(`[data-root-star-status="${CSS.escape(String(langId))}"]`);

        const type = (typeEl?.value || "").trim();
        const text = (textEl?.value || "").trim();

        if (!type || !text) {
          alert("Provide both star type and star text.");
          return;
        }

        statusEl.textContent = "adding…";
        try {
          await apiPost(
            `/api/lang/${encodeURIComponent(langId)}/stars`,
            { type, text, parent_star_id: null },
            { admin: true },
          );
          typeEl.value = "";
          textEl.value = "";
          statusEl.textContent = "added";
          setTimeout(() => statusEl.textContent = "", 900);
          await loadEntries();
        } catch (e) {
          statusEl.textContent = "";
          alert(e.message || String(e));
        }
      });
    }

    // wire append text
    for (const btn of document.querySelectorAll("button[data-append-star]")) {
      btn.addEventListener("click", async () => {
        const starId = btn.getAttribute("data-append-star");
        if (!starId) return;

        const textEl = document.querySelector(`[data-append-text="${CSS.escape(String(starId))}"]`);
        const statusEl = document.querySelector(`[data-append-status="${CSS.escape(String(starId))}"]`);
        const text = (textEl?.value || "").trim();

        if (!text) {
          alert("Provide star text to append.");
          return;
        }

        statusEl.textContent = "adding…";
        try {
          await apiPost(
            `/api/stars/${encodeURIComponent(starId)}/texts`,
            { text },
            { admin: true },
          );
          textEl.value = "";
          statusEl.textContent = "added";
          setTimeout(() => statusEl.textContent = "", 900);
          await loadEntries();
        } catch (e) {
          statusEl.textContent = "";
          alert(e.message || String(e));
        }
      });
    }

    // wire add child star
    for (const btn of document.querySelectorAll("button[data-add-child-star]")) {
      btn.addEventListener("click", async () => {
        const parentId = btn.getAttribute("data-add-child-star");
        const langId = btn.getAttribute("data-lang-id");
        if (!parentId || !langId) return;

        const typeEl = document.querySelector(`[data-child-type="${CSS.escape(String(parentId))}"]`);
        const textEl = document.querySelector(`[data-child-text="${CSS.escape(String(parentId))}"]`);
        const statusEl = document.querySelector(`[data-child-status="${CSS.escape(String(parentId))}"]`);

        const type = (typeEl?.value || "").trim();
        const text = (textEl?.value || "").trim();

        if (!type || !text) {
          alert("Provide both child type and child text.");
          return;
        }

        statusEl.textContent = "adding…";
        try {
          await apiPost(
            `/api/lang/${encodeURIComponent(langId)}/stars`,
            { type, text, parent_star_id: parentId },
            { admin: true },
          );
          typeEl.value = "";
          textEl.value = "";
          statusEl.textContent = "added";
          setTimeout(() => statusEl.textContent = "", 900);
          await loadEntries();
        } catch (e) {
          statusEl.textContent = "";
          alert(e.message || String(e));
        }
      });
    }

    // wire focus
    for (const btn of document.querySelectorAll("button[data-focus-lang]")) {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-focus-lang");
        if (!id) return;
        setFocus(id);
        await loadEntries();
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    }
  }

  async function createEntry() {
    const text = ($("textInput").value || "").trim();
    if (!text) return;
    $("status").textContent = "creating…";
    try {
      await apiPost("/api/lang", { text }, { admin: true });
      $("textInput").value = "";
      await loadEntries();
      $("status").textContent = "created";
      setTimeout(() => ($("status").textContent = ""), 900);
    } catch (e) {
      $("status").textContent = "";
      alert(e.message || String(e));
    }
  }

  // UI wiring
  $("setKeyBtn").addEventListener("click", async () => {
    const v = prompt("Enter admin key:");
    if (v) setAdminKey(v);
    const ok = await refreshAdmin();
    if (ok) await loadEntries();
  });

  $("clearKeyBtn").addEventListener("click", async () => {
    clearAdminKey();
    await refreshAdmin();
  });

  $("refreshBtn").addEventListener("click", async () => {
    const ok = await refreshAdmin();
    if (ok) await loadEntries();
  });

  $("showAllBtn").addEventListener("click", async () => {
    setFocus(null);
    await loadEntries();
  });

  $("createBtn").addEventListener("click", createEntry);
  $("clearBtn").addEventListener("click", () => ($("textInput").value = ""));

  // init
  (async function init(){
    readFocusFromUrl();
    const ok = await refreshAdmin();
    if (ok) await loadEntries();
    $("meta").textContent = "POST /api/lang • POST /api/lang/:id/stars • POST /api/stars/:id/texts";
  })();
</script>
</body>
</html>
