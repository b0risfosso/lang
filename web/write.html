<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>write</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; line-height: 1.35; }
    header { padding: 14px 16px; border-bottom: 1px solid color-mix(in oklab, currentColor 22%, transparent); display:flex; align-items:baseline; justify-content:space-between; gap: 12px; }
    h1 { font-size: 18px; margin: 0; }
    main { max-width: 70rem; margin: 0 auto; padding: 16px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .pill { display:inline-block; border: 1px solid color-mix(in oklab, currentColor 60%, transparent); border-radius: 999px; padding: 2px 10px; font-size: 12px; }
    .muted { opacity: .75; }
    .card { border: 1px solid color-mix(in oklab, currentColor 18%, transparent); border-radius: 14px; padding: 12px; margin: 12px 0; }
    button { font: inherit; padding: 8px 10px; border-radius: 10px; border: 1px solid color-mix(in oklab, currentColor 30%, transparent); background: transparent; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    textarea, input { font: inherit; padding: 8px 10px; border-radius: 10px; border: 1px solid color-mix(in oklab, currentColor 30%, transparent); background: transparent; }
    textarea { width: 100%; min-height: 110px; resize: vertical; }
    .danger { border-color: color-mix(in oklab, red 55%, currentColor 18%); }
    .entry { padding: 10px; border-radius: 12px; border: 1px solid color-mix(in oklab, currentColor 18%, transparent); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
<header>
  <div class="row">
    <h1>write</h1>
    <span class="pill" id="adminPill">admin: …</span>
  </div>
  <div class="row">
    <button id="setKeyBtn" type="button">set admin key</button>
    <button id="clearKeyBtn" type="button">clear key</button>
    <button id="refreshBtn" type="button">refresh</button>
  </div>
</header>

<main>
  <section class="card" id="lockedCard">
    <div class="row" style="justify-content:space-between;">
      <strong>locked</strong>
      <span class="muted">This page is admin-protected.</span>
    </div>
    <div class="muted" style="margin-top:8px;">
      Set <span class="mono">localStorage.lang_admin_key</span> to unlock.
    </div>
  </section>

  <section class="card" id="composerCard" style="display:none;">
    <div class="row" style="justify-content:space-between;">
      <strong>new lang entry</strong>
      <span class="muted" id="meta">…</span>
    </div>
    <div style="margin-top:10px;">
      <textarea id="textInput" placeholder="type text…"></textarea>
    </div>
    <div class="row" style="margin-top:10px; justify-content:space-between;">
      <div class="row">
        <button id="createBtn" type="button">create</button>
        <button id="clearBtn" type="button">clear</button>
      </div>
      <span class="muted" id="status"></span>
    </div>
  </section>

  <section class="card" id="listCard" style="display:none;">
    <div class="row" style="justify-content:space-between;">
      <strong>entries</strong>
      <span class="muted" id="listMeta">…</span>
    </div>
    <div id="listHost" style="margin-top:10px;"></div>
  </section>
</main>

<script>
  const $ = (id) => document.getElementById(id);

  function getAdminKey() {
    return localStorage.getItem("lang_admin_key") || "";
  }

  function setAdminKey(v) {
    localStorage.setItem("lang_admin_key", v);
  }

  function clearAdminKey() {
    localStorage.removeItem("lang_admin_key");
  }

  function withAdminHeaders(h = {}) {
    const k = getAdminKey();
    if (k) h["X-Admin-Key"] = k;
    return h;
  }

  async function apiGet(url, { admin = false } = {}) {
    const headers = { "Accept": "application/json" };
    if (admin) Object.assign(headers, withAdminHeaders());
    const res = await fetch(url, { headers });
    if (!res.ok) throw new Error(`GET ${url} failed (${res.status})`);
    return await res.json();
  }

  async function apiJson(method, url, body, { admin = false } = {}) {
    const headers = { "Accept": "application/json", "Content-Type": "application/json" };
    if (admin) Object.assign(headers, withAdminHeaders());
    const res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : undefined });
    const txt = await res.text();
    let data = null;
    try { data = txt ? JSON.parse(txt) : null; } catch {}
    if (!res.ok) {
      const msg = (data && (data.description || data.error)) || `${method} ${url} failed (${res.status})`;
      throw new Error(msg);
    }
    return data;
  }

  const apiPost = (url, body, opts) => apiJson("POST", url, body, opts);
  const apiDelete = (url, opts) => apiJson("DELETE", url, null, opts);

  function esc(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function refreshAdmin() {
    const k = getAdminKey();
    if (!k) {
      $("adminPill").textContent = "admin: no key";
      $("lockedCard").style.display = "";
      $("composerCard").style.display = "none";
      $("listCard").style.display = "none";
      return false;
    }
    try {
      await apiGet("/api/admin/ping", { admin: true });
      $("adminPill").textContent = "admin: ok";
      $("lockedCard").style.display = "none";
      $("composerCard").style.display = "";
      $("listCard").style.display = "";
      return true;
    } catch {
      $("adminPill").textContent = "admin: invalid";
      $("lockedCard").style.display = "";
      $("composerCard").style.display = "none";
      $("listCard").style.display = "none";
      return false;
    }
  }

  async function loadEntries() {
    $("listHost").innerHTML = `<div class="muted">loading…</div>`;
    const data = await apiGet("/api/lang");
    const entries = Array.isArray(data.entries) ? data.entries : [];
    $("listMeta").textContent = `${entries.length} shown`;

    $("listHost").innerHTML = "";
    for (const e of entries) {
      const div = document.createElement("div");
      div.className = "entry";
      div.style.marginTop = "10px";
      div.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div class="muted mono">#${esc(e.id)} • ${esc(e.updated_at || e.created_at || "")}</div>
          <button data-del="${esc(e.id)}" type="button">delete</button>
        </div>
        <div style="margin-top:8px; white-space:pre-wrap;">${esc(e.text)}</div>
      `;
      $("listHost").appendChild(div);
    }

    // wire deletes
    for (const btn of document.querySelectorAll("button[data-del]")) {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-del");
        if (!id) return;
        if (!confirm(`Delete #${id}?`)) return;
        try {
          await apiDelete(`/api/lang/${encodeURIComponent(id)}`, { admin: true });
          await loadEntries();
        } catch (e) {
          alert(e.message || String(e));
        }
      });
    }
  }

  async function createEntry() {
    const text = ($("textInput").value || "").trim();
    if (!text) return;
    $("status").textContent = "creating…";
    try {
      await apiPost("/api/lang", { text }, { admin: true });
      $("textInput").value = "";
      await loadEntries();
      $("status").textContent = "created";
      setTimeout(() => ($("status").textContent = ""), 900);
    } catch (e) {
      $("status").textContent = "";
      alert(e.message || String(e));
    }
  }

  // UI wiring
  $("setKeyBtn").addEventListener("click", async () => {
    const v = prompt("Enter admin key:");
    if (v) setAdminKey(v);
    await refreshAdmin();
    if (getAdminKey()) await loadEntries();
  });

  $("clearKeyBtn").addEventListener("click", async () => {
    clearAdminKey();
    await refreshAdmin();
  });

  $("refreshBtn").addEventListener("click", async () => {
    const ok = await refreshAdmin();
    if (ok) await loadEntries();
  });

  $("createBtn").addEventListener("click", createEntry);
  $("clearBtn").addEventListener("click", () => ($("textInput").value = ""));

  // init
  (async function init(){
    const ok = await refreshAdmin();
    if (ok) await loadEntries();
    $("meta").textContent = "POST /api/lang • GET /api/lang";
  })();
</script>
</body>
</html>
