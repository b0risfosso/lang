<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>lang word</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; line-height: 1.5; }
    main { max-width: 52rem; margin: 10vh auto; }
    a { text-decoration: none; border-bottom: 1px solid currentColor; }

    .word { font-size: 2rem; margin: 0 0 .75rem; }
    .meta { opacity: .85; display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin-bottom: 1.25rem; }
    .pill { border: 1px solid currentColor; border-radius: 999px; padding: .15rem .6rem; font-size: .9rem; }

    .panel { border: 1px solid color-mix(in oklab, currentColor 40%, transparent); border-radius: 1rem; padding: 1rem; margin-top: 1rem; }
    .panel h2 { font-size: 1rem; margin: 0 0 .75rem; }

    .row { display:flex; gap:.5rem; align-items:center; margin:.5rem 0; }
    input[type="text"], select {
      width: 100%; padding: .5rem .6rem; border-radius: .5rem;
      border: 1px solid currentColor; background: transparent; color: inherit;
    }
    button {
      border: 1px solid currentColor; background: transparent; color: inherit;
      border-radius: .6rem; padding: .45rem .7rem; cursor: pointer;
      white-space: nowrap;
    }
    button:focus, input:focus, select:focus { outline: 2px solid currentColor; outline-offset: 2px; }
    .muted { opacity: .75; }

    .version-head { display:flex; gap:.5rem; align-items:center; justify-content:space-between; }
    .version-title { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }

    ul { padding-left: 1.25rem; margin: .5rem 0 0; }
    li { margin: .35rem 0; }

    .child-edit-row { display:flex; gap:.5rem; align-items:center; margin:.4rem 0; }
    .child-edit-row input { flex: 1; }
  </style>
</head>
<body>
  <main>
    <p><a href="./">← back</a></p>

    <h1 class="word" id="word">…</h1>

    <div class="meta">
      <span class="pill" id="lang-pill">lang_word …</span>
      <span class="pill" id="ver-pill">version …</span>
      <span class="pill" id="mode-pill">view</span>
      <button id="admin-btn" type="button">enter admin key</button>
      <button id="clear-admin-btn" type="button" style="display:none;">clear key</button>
    </div>

    <section class="panel">
      <h2>versions</h2>

      <div id="edit-top" style="display:none;">
        <div class="row">
          <button id="create-version" type="button">create new version</button>
          <span class="muted" id="create-version-msg"></span>
        </div>

        <div class="row">
          <select id="add-to-version"></select>
        </div>

        <div class="row">
          <input id="new-child" type="text" placeholder="new child word (⌘/Ctrl + Enter)" />
          <button id="add-child" type="button">add</button>
        </div>
      </div>

      <div id="versions-container"></div>
      <p id="empty" class="muted" style="display:none;">no versions found.</p>
    </section>
  </main>

  <script>
    const ADMIN_KEY_STORAGE = "lang_admin_key";

    const params = new URLSearchParams(location.search);
    const versionIdParam = params.get("id"); // this is a VERSION id

    const wordEl = document.getElementById("word");
    const langPill = document.getElementById("lang-pill");
    const verPill = document.getElementById("ver-pill");
    const modePill = document.getElementById("mode-pill");

    const adminBtn = document.getElementById("admin-btn");
    const clearAdminBtn = document.getElementById("clear-admin-btn");

    const editTop = document.getElementById("edit-top");
    const createVersionBtn = document.getElementById("create-version");
    const createVersionMsg = document.getElementById("create-version-msg");

    const addToVersionSelect = document.getElementById("add-to-version");
    const newChildInput = document.getElementById("new-child");
    const addChildBtn = document.getElementById("add-child");

    const versionsContainer = document.getElementById("versions-container");
    const emptyEl = document.getElementById("empty");

    let adminVerified = false;
    let currentData = null; // payload from GET /api/lang_words/<version_id>

    function getAdminKey() {
      return localStorage.getItem(ADMIN_KEY_STORAGE) || "";
    }
    function setAdminKey(key) {
      localStorage.setItem(ADMIN_KEY_STORAGE, key);
    }
    function clearAdminKey() {
      localStorage.removeItem(ADMIN_KEY_STORAGE);
    }
    function isEditMode() {
      return adminVerified;
    }

    async function verifyAdminKey() {
      const key = getAdminKey();
      if (!key) { adminVerified = false; return false; }

      const res = await fetch("/api/admin/ping", {
        headers: { "Accept": "application/json", "X-Admin-Key": key }
      });

      if (res.ok) { adminVerified = true; return true; }

      clearAdminKey();
      adminVerified = false;
      return false;
    }

    function setModeUI() {
      const edit = isEditMode();
      modePill.textContent = edit ? "edit" : "view";
      editTop.style.display = edit ? "" : "none";
      clearAdminBtn.style.display = edit ? "" : "none";
      adminBtn.textContent = edit ? "admin verified" : "enter admin key";
      adminBtn.disabled = edit;
    }

    async function apiFetch(url, opts = {}) {
      const res = await fetch(url, opts);
      if (res.status === 401) {
        // key wrong/expired -> revert
        clearAdminKey();
        adminVerified = false;
        setModeUI();
      }
      return res;
    }

    function openVersion(versionId) {
      window.location.href = `lang_word.html?id=${encodeURIComponent(versionId)}`;
    }

    async function loadWordAndVersions() {
      if (!versionIdParam) {
        wordEl.textContent = "missing version id";
        verPill.textContent = "version ?";
        langPill.textContent = "lang_word ?";
        return null;
      }

      const res = await apiFetch(`/api/lang_words/${encodeURIComponent(versionIdParam)}`, {
        headers: { "Accept": "application/json" }
      });

      if (!res.ok) {
        wordEl.textContent = "word/version not found";
        return null;
      }

      const data = await res.json();
      currentData = data;

      wordEl.textContent = data.word;
      document.title = data.word;

      langPill.textContent = `lang_word ${data.lang_word_id}`;
      verPill.textContent = `version ${data.current_version} (id ${data.current_version_id})`;

      renderVersions(data);
      return data;
    }

    function renderVersions(data) {
      const versions = Array.isArray(data.versions) ? data.versions : [];
      versionsContainer.innerHTML = "";
      emptyEl.style.display = versions.length ? "none" : "";

      // Populate the "add child to version" select (edit mode)
      addToVersionSelect.innerHTML = "";
      for (const v of versions) {
        const opt = document.createElement("option");
        opt.value = String(v.version_id);
        opt.textContent = `Version ${v.version} (id ${v.version_id})`;
        if (v.version_id === data.current_version_id) opt.selected = true;
        addToVersionSelect.appendChild(opt);
      }

      for (const v of versions) {
        const panel = document.createElement("div");
        panel.className = "panel";

        // header
        const head = document.createElement("div");
        head.className = "version-head";

        const left = document.createElement("div");
        left.className = "version-title";
        const title = document.createElement("strong");
        title.textContent = `Version ${v.version}`;
        const idP = document.createElement("span");
        idP.className = "pill";
        idP.textContent = `id ${v.version_id}`;
        left.appendChild(title);
        left.appendChild(idP);

        const right = document.createElement("div");
        const openBtn = document.createElement("button");
        openBtn.type = "button";
        openBtn.textContent = (v.version_id === data.current_version_id) ? "current" : "open";
        openBtn.disabled = (v.version_id === data.current_version_id);
        openBtn.addEventListener("click", () => openVersion(v.version_id));
        right.appendChild(openBtn);

        head.appendChild(left);
        head.appendChild(right);
        panel.appendChild(head);

        // child words (view list)
        const kids = Array.isArray(v.child_words) ? v.child_words : [];
        const ul = document.createElement("ul");
        for (const c of kids) {
          const li = document.createElement("li");
          li.textContent = c.word;
          ul.appendChild(li);
        }
        if (!kids.length) {
          const p = document.createElement("p");
          p.className = "muted";
          p.style.margin = ".5rem 0 0";
          p.textContent = "no child words.";
          panel.appendChild(p);
        } else {
          panel.appendChild(ul);
        }

        // edit UI per version
        if (isEditMode()) {
          const editWrap = document.createElement("div");
          editWrap.style.marginTop = ".75rem";

          const label = document.createElement("div");
          label.className = "muted";
          label.textContent = "edit child words (this version)";
          editWrap.appendChild(label);

          for (const c of kids) {
            const row = document.createElement("div");
            row.className = "child-edit-row";

            const input = document.createElement("input");
            input.type = "text";
            input.value = c.word;

            const save = document.createElement("button");
            save.type = "button";
            save.textContent = "save";

            const del = document.createElement("button");
            del.type = "button";
            del.textContent = "delete";

            save.addEventListener("click", async () => {
              const next = input.value.trim();
              if (!next) return;

              const key = getAdminKey();
              const r = await apiFetch(`/api/child_words/${c.id}`, {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  "Accept": "application/json",
                  "X-Admin-Key": key
                },
                body: JSON.stringify({ word: next })
              });

              if (!r.ok) {
                const err = await r.json().catch(() => ({}));
                alert(err.error || `save failed (${r.status})`);
                return;
              }
              await refresh();
            });

            del.addEventListener("click", async () => {
              if (!confirm("delete this child word?")) return;

              const key = getAdminKey();
              const r = await apiFetch(`/api/child_words/${c.id}`, {
                method: "DELETE",
                headers: { "Accept": "application/json", "X-Admin-Key": key }
              });

              if (!r.ok) {
                const err = await r.json().catch(() => ({}));
                alert(err.error || `delete failed (${r.status})`);
                return;
              }
              await refresh();
            });

            row.appendChild(input);
            row.appendChild(save);
            row.appendChild(del);
            editWrap.appendChild(row);
          }

          panel.appendChild(editWrap);
        }

        versionsContainer.appendChild(panel);
      }
    }

    async function refresh() {
      // keep verified state; just reload data + render
      await loadWordAndVersions();
      setModeUI(); // ensures edit sections show/hide correctly
      if (currentData) renderVersions(currentData);
    }

    // Create new version (admin)
    createVersionBtn.addEventListener("click", async () => {
      if (!currentData) return;
      const key = getAdminKey();
      if (!key) return;

      createVersionMsg.textContent = "";

      const r = await apiFetch(`/api/lang_words/${currentData.lang_word_id}/versions`, {
        method: "POST",
        headers: { "Accept": "application/json", "X-Admin-Key": key }
      });

      if (!r.ok) {
        const err = await r.json().catch(() => ({}));
        createVersionMsg.textContent = err.error || `create failed (${r.status})`;
        return;
      }

      const out = await r.json();
      createVersionMsg.textContent = `created version ${out.version} (id ${out.version_id})`;
      // switch page to new version immediately:
      openVersion(out.version_id);
    });

    // Add child to selected version
    addChildBtn.addEventListener("click", async () => {
      if (!isEditMode()) return;
      const key = getAdminKey();
      if (!key) return;

      const word = newChildInput.value.trim();
      if (!word) return;

      const versionId = Number(addToVersionSelect.value);
      if (!Number.isInteger(versionId) || versionId <= 0) return;

      const r = await apiFetch(`/api/lang_word_versions/${encodeURIComponent(versionId)}/child_words`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "X-Admin-Key": key
        },
        body: JSON.stringify({ word })
      });

      if (!r.ok) {
        const err = await r.json().catch(() => ({}));
        alert(err.error || `add failed (${r.status})`);
        return;
      }

      newChildInput.value = "";
      await refresh();
    });

    // Cmd/Ctrl+Enter in add-child input triggers add
    newChildInput.addEventListener("keydown", (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === "Enter") {
        e.preventDefault();
        addChildBtn.click();
      }
    });

    // Admin buttons
    adminBtn.addEventListener("click", async () => {
      const key = prompt("Admin key (stored locally):", getAdminKey() || "");
      if (!key || !key.trim()) return;

      setAdminKey(key.trim());
      const ok = await verifyAdminKey();
      setModeUI();
      await refresh();

      if (!ok) alert("Admin key invalid.");
    });

    clearAdminBtn.addEventListener("click", async () => {
      clearAdminKey();
      adminVerified = false;
      setModeUI();
      await refresh();
    });

    // boot
    (async () => {
      await verifyAdminKey();
      setModeUI();
      await loadWordAndVersions();
    })();
  </script>
</body>
</html>
