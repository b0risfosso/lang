<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>lang</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; line-height: 1.5; }
    main { max-width: 42rem; margin: 10vh auto; text-align: center; position: relative; z-index: 1; }
    h1 { font-size: 1.25rem; margin: 0 0 1rem; }
    p { margin: 0 0 1.25rem; }
    .media-row { display: flex; gap: 1rem; align-items: stretch; justify-content: center; }
    .media-row img, .media-row video { width: 100%; max-width: 14rem; height: auto; object-fit: cover; border-radius: .25rem; }
    @media (max-width: 720px) { .media-row { flex-direction: column; } .media-row img, .media-row video { max-width: 100%; } }

    #word-layer { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
    .thought {
      position: absolute; left: 0; top: 0; transform: translate3d(0,0,0);
      padding: .25rem .5rem; border-radius: .75rem;
      border: 1px solid color-mix(in oklab, currentColor 70%, transparent);
      background: color-mix(in oklab, Canvas 85%, transparent);
      backdrop-filter: blur(4px); font-size: .95rem; white-space: nowrap; opacity: .85;
      will-change: transform; user-select: none;
    }

    #list-toggle-btn, #sentences-btn, #manage-btn, #admin-btn {
      position: fixed; bottom: 1.25rem; z-index: 2;
      border: 1px solid currentColor;
      background: color-mix(in oklab, Canvas 85%, transparent);
      backdrop-filter: blur(6px);
      border-radius: 999px; padding: .6rem .9rem; cursor: pointer; font-size: 1rem; line-height: 1;
    }
    #sentences-btn { right: 1.25rem; }
    #list-toggle-btn { right: 4.25rem; }
    #manage-btn { right: 7.25rem; display:none; }
    #admin-btn { right: 10.25rem; }

    #word-list {
      position: fixed; top: 1.25rem; left: 1.25rem; right: 1.25rem; bottom: 1.25rem;
      max-width: 56rem; margin: 0 auto; z-index: 3; display: none;
      border: 1px solid color-mix(in oklab, currentColor 40%, transparent);
      border-radius: 1rem;
      background: color-mix(in oklab, Canvas 92%, transparent);
      backdrop-filter: blur(6px);
      padding: 1rem;
      box-shadow: 0 0 30px color-mix(in oklab, currentColor 15%, transparent);
      overflow: auto;
    }
    #word-list h2 { margin: 0 0 .75rem; font-size: 1rem; font-weight: 600; text-align: left; }
    #word-list .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(11rem, 1fr)); gap: .5rem .75rem; text-align: left; }
    #word-list a { display: inline-block; text-decoration: none; padding: .45rem .6rem; border-radius: .6rem;
      border: 1px solid color-mix(in oklab, currentColor 35%, transparent); }
    #word-list .muted { opacity: .75; font-size: .9rem; margin-top: .5rem; text-align: left; }

    body.list-mode #word-layer { display: none; }

    #overlay { position: fixed; inset: 0; background: color-mix(in oklab, Canvas 70%, transparent); backdrop-filter: blur(2px); display: none; z-index: 50; }
    #sidepanel {
      position: fixed; top: 0; right: 0; height: 100%; width: min(620px, 94vw);
      background: Canvas;
      border-left: 1px solid color-mix(in oklab, currentColor 40%, transparent);
      box-shadow: 0 0 30px color-mix(in oklab, currentColor 20%, transparent);
      transform: translateX(100%); transition: transform 180ms ease;
      z-index: 51; display: flex; flex-direction: column;
    }
    #sidepanel.open { transform: translateX(0); }
    #sidepanel header { padding: 1rem; border-bottom: 1px solid color-mix(in oklab, currentColor 40%, transparent); display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
    #sidepanel .content { padding: 1rem; overflow: auto; }
    .panel { border: 1px solid color-mix(in oklab, currentColor 40%, transparent); border-radius: 1rem; padding: 1rem; margin-top: 1rem; }
    .panel h2 { font-size: 1rem; margin: 0 0 .75rem; }
    .row { display:flex; gap:.5rem; align-items:center; }
    input[type="text"]{
      width: 100%; padding: .5rem .6rem; border-radius: .5rem;
      border: 1px solid currentColor; background: transparent; color: inherit;
    }
    button.small { border: 1px solid currentColor; background: transparent; color: inherit; border-radius: .6rem; padding: .45rem .7rem; cursor: pointer; white-space: nowrap; }
    .muted { opacity: .75; }
    .wordgrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(14rem, 1fr)); gap: .5rem .6rem; }
    .worditem { border: 1px solid color-mix(in oklab, currentColor 25%, transparent); border-radius: .75rem; padding: .45rem .55rem; display:flex; gap:.5rem; align-items:center; }
  </style>
</head>
<body>
  <div id="word-layer" aria-hidden="true"></div>

  <section id="word-list" aria-label="Lang word list">
    <h2 id="list-title">words</h2>
    <div class="grid" id="word-list-grid"></div>
    <div class="muted" id="word-list-meta"></div>
  </section>

  <button id="admin-btn" type="button" aria-label="Enter admin key">key</button>
  <button id="manage-btn" type="button" aria-label="Manage words">✎</button>
  <button id="list-toggle-btn" type="button" aria-label="Toggle word list">☰</button>
  <button id="sentences-btn" type="button" aria-label="Open sentences">ls</button>

  <main>
    <p style="margin:0 0 .5rem;"><a href="./">← back</a></p>
    <h1 id="lang-title">…</h1>
    <p class="muted" id="lang-meta">…</p>

    <div class="media-row">
      <img src="Michelangelo_-_Creation_of_Adam_(cropped)-2.jpg" alt="Michelangelo, The Creation of Adam (cropped)" loading="lazy" />
      <video controls autoplay loop muted playsinline preload="metadata">
        <source src="YTDown.com_YouTube_I-think-I-can-I-think-I-can-the-Little-E_Media_Yx9xO98kcBU_001_360p.mp4" type="video/mp4" />
      </video>
      <video controls autoplay loop muted playsinline preload="metadata">
        <source src="YTDown.com_YouTube_Interstellar-Gargantua-Detach-Scene-1080_Media__GdEsdEfZvc_001_720p.mp4" type="video/mp4" />
      </video>
    </div>
  </main>

  <div id="overlay" aria-hidden="true"></div>
  <aside id="sidepanel" aria-label="manage lang">
    <header>
      <strong>manage lang</strong>
      <button id="close-panel" class="small" type="button">close</button>
    </header>
    <div class="content">
      <section class="panel" style="margin-top:0;">
        <h2>name</h2>
        <div class="row">
          <input id="name-input" type="text" placeholder="lang name" />
          <button id="save-name" class="small" type="button">save</button>
        </div>
        <div class="muted" id="save-name-msg" style="margin-top:.5rem;"></div>
      </section>

      <section class="panel">
        <h2>words in this lang</h2>
        <p class="muted" style="margin-top:0;">Select words, then press save.</p>
        <div class="wordgrid" id="all-words"></div>
        <div class="row" style="margin-top:.75rem;">
          <button id="save-words" class="small" type="button">save words</button>
          <span class="muted" id="save-words-msg"></span>
        </div>
      </section>
    </div>
  </aside>

  <script>
    const API_BASE = "";
    const ADMIN_KEY_STORAGE = "lang_admin_key";
    const params = new URLSearchParams(location.search);
    const langId = params.get("id");

    const layer = document.getElementById("word-layer");
    const mainEl = document.querySelector("main");

    const adminBtn = document.getElementById("admin-btn");
    const manageBtn = document.getElementById("manage-btn");
    const listToggleBtn = document.getElementById("list-toggle-btn");
    const sentencesBtn = document.getElementById("sentences-btn");

    const langTitle = document.getElementById("lang-title");
    const langMeta = document.getElementById("lang-meta");

    const listPanel = document.getElementById("word-list");
    const listTitle = document.getElementById("list-title");
    const listGrid = document.getElementById("word-list-grid");
    const listMeta = document.getElementById("word-list-meta");

    const overlay = document.getElementById("overlay");
    const sidepanel = document.getElementById("sidepanel");
    const closePanelBtn = document.getElementById("close-panel");

    const nameInput = document.getElementById("name-input");
    const saveNameBtn = document.getElementById("save-name");
    const saveNameMsg = document.getElementById("save-name-msg");

    const allWordsEl = document.getElementById("all-words");
    const saveWordsBtn = document.getElementById("save-words");
    const saveWordsMsg = document.getElementById("save-words-msg");

    const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    const rand = (min, max) => Math.random() * (max - min) + min;

    let adminVerified = false;
    let listMode = false;

    let langData = null;   // GET /api/langs/<id>
    let cachedWords = [];  // words within this lang: [{word, version_id,...}]
    let allWords = [];     // all words for manage panel

    const mouse = { x: null, y: null };
    window.addEventListener("pointermove", (e) => { mouse.x = e.clientX; mouse.y = e.clientY; }, { passive: true });

    function getAdminKey() { return localStorage.getItem(ADMIN_KEY_STORAGE) || ""; }
    function setAdminKey(key) { localStorage.setItem(ADMIN_KEY_STORAGE, key); }
    function clearAdminKey() { localStorage.removeItem(ADMIN_KEY_STORAGE); }

    async function verifyAdminKey() {
      const key = getAdminKey();
      if (!key) { adminVerified = false; return false; }
      const res = await fetch("/api/admin/ping", { headers: { "Accept": "application/json", "X-Admin-Key": key } });
      if (res.ok) { adminVerified = true; return true; }
      clearAdminKey(); adminVerified = false; return false;
    }

    function setAdminUI() {
      adminBtn.textContent = adminVerified ? "ok" : "key";
      manageBtn.style.display = adminVerified ? "inline-block" : "none";
    }

    function openWordPage(versionId) {
      const url = `lang_word.html?id=${encodeURIComponent(versionId)}`;
      window.open(url, "_blank", "noopener,noreferrer");
    }

    function getAvoidRect() {
      const r = mainEl.getBoundingClientRect();
      const pad = 24;
      return { left: r.left - pad, top: r.top - pad, right: r.right + pad, bottom: r.bottom + pad };
    }
    function pointOutsideRect(x, y, rect) {
      return (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom);
    }
    function pickTarget(el) {
      const vw = window.innerWidth, vh = window.innerHeight;
      const rect = getAvoidRect();
      const b = el.getBoundingClientRect();
      const w = b.width || 80, h = b.height || 24;
      for (let i = 0; i < 25; i++) {
        const x = rand(0, Math.max(0, vw - w));
        const y = rand(0, Math.max(0, vh - h));
        if (pointOutsideRect(x + w / 2, y + h / 2, rect)) return { x, y };
      }
      return { x: rand(0, Math.max(0, vw - w)), y: rand(0, Math.max(0, vh - h)) };
    }

    function createThought(item) {
      const { word, version_id } = item;
      const el = document.createElement("div");
      el.className = "thought";
      el.textContent = word;
      el.style.pointerEvents = "auto";
      el.style.cursor = "pointer";
      el.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); openWordPage(version_id); });

      const speedPxPerSec = rand(40, 180);
      const jitter = rand(0.6, 2.2);
      const reactRadius = rand(60, 140);
      const reactStrength = rand(0.6, 1.6);

      let pos = { x: rand(0, window.innerWidth * 0.8), y: rand(0, window.innerHeight * 0.8) };
      let target = pickTarget(el);
      let lastT = performance.now();

      el.style.transform = `translate3d(${pos.x}px, ${pos.y}px, 0)`;

      function step(now) {
        const dt = Math.min(0.05, (now - lastT) / 1000);
        lastT = now;

        if (!prefersReducedMotion) {
          let vx = target.x - pos.x, vy = target.y - pos.y;
          const dist = Math.hypot(vx, vy) || 1;
          if (dist < 6) { if (Math.random() < 0.08) target = pickTarget(el); }
          else {
            const stepDist = Math.min(dist, speedPxPerSec * dt);
            pos.x += (vx / dist) * stepDist;
            pos.y += (vy / dist) * stepDist;
          }
          pos.x += (Math.random() - 0.5) * jitter;
          pos.y += (Math.random() - 0.5) * jitter;

          if (mouse.x !== null && mouse.y !== null) {
            const dx = pos.x - mouse.x, dy = pos.y - mouse.y;
            const d = Math.hypot(dx, dy) || 1;
            if (d < reactRadius) {
              const force = (1 - d / reactRadius) * reactStrength * 120;
              pos.x += (dx / d) * force * dt;
              pos.y += (dy / d) * force * dt;
            }
          }
        }

        const b = el.getBoundingClientRect();
        const w = b.width || 80, h = b.height || 24;
        const maxX = Math.max(0, window.innerWidth - w);
        const maxY = Math.max(0, window.innerHeight - h);
        pos.x = Math.max(0, Math.min(maxX, pos.x));
        pos.y = Math.max(0, Math.min(maxY, pos.y));

        el.style.transform = `translate3d(${pos.x}px, ${pos.y}px, 0)`;
        requestAnimationFrame(step);
      }

      requestAnimationFrame(step);
      return el;
    }

    function mountWords(words) {
      layer.innerHTML = "";
      words.forEach((obj) => layer.appendChild(createThought(obj)));
    }

    function mountList(words) {
      listGrid.innerHTML = "";
      const sorted = [...words].sort((a, b) => String(a.word).localeCompare(String(b.word)));
      sorted.forEach((item) => {
        const a = document.createElement("a");
        a.href = `lang_word.html?id=${encodeURIComponent(item.version_id)}`;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = item.word;
        a.addEventListener("click", (e) => { e.preventDefault(); openWordPage(item.version_id); });
        listGrid.appendChild(a);
      });
      listMeta.textContent = `${sorted.length} words`;
    }

    function setListMode(on) {
      listMode = !!on;
      document.body.classList.toggle("list-mode", listMode);
      listPanel.style.display = listMode ? "block" : "none";
      listToggleBtn.textContent = listMode ? "✕" : "☰";
      if (listMode) mountList(cachedWords);
      else mountWords(cachedWords);
    }

    async function fetchLang() {
      if (!langId) throw new Error("Missing id");
      const res = await fetch(`${API_BASE}/api/langs/${encodeURIComponent(langId)}`, { headers: { "Accept": "application/json" } });
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error || `Failed to load lang (${res.status})`);
      }
      return res.json();
    }

    async function refreshWords() {
      try {
        langData = await fetchLang();
        document.title = langData.name || "lang";
        langTitle.textContent = langData.name || "lang";
        langMeta.textContent = `id ${langData.id} · ${(langData.lang_word_ids || []).length} word(s)`;
        listTitle.textContent = `words · ${langData.name || "lang"}`;

        cachedWords = Array.isArray(langData.words) ? langData.words : [];
        if (listMode) mountList(cachedWords);
        else mountWords(cachedWords);

        nameInput.value = langData.name || "";
      } catch (err) {
        langTitle.textContent = "lang not found";
        langMeta.textContent = err.message || String(err);
        cachedWords = [];
        if (listMode) mountList([]);
        else mountWords([]);
      }
    }

    async function fetchAllWords() {
      const res = await fetch(`${API_BASE}/api/lang_words`, { headers: { "Accept": "application/json" } });
      if (!res.ok) throw new Error(`Failed to load words: ${res.status}`);
      const data = await res.json();
      return Array.isArray(data.words) ? data.words : [];
    }

    function openPanel() { overlay.style.display = "block"; sidepanel.classList.add("open"); }
    function closePanel() { overlay.style.display = "none"; sidepanel.classList.remove("open"); saveNameMsg.textContent = ""; saveWordsMsg.textContent = ""; }

    function renderAllWordsChecklist() {
      allWordsEl.innerHTML = "";
      const selected = new Set(Array.isArray(langData?.lang_word_ids) ? langData.lang_word_ids : []);
      const sorted = [...allWords].sort((a,b) => String(a.word).localeCompare(String(b.word)));

      for (const w of sorted) {
        const label = document.createElement("label");
        label.className = "worditem";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = selected.has(w.lang_word_id);
        cb.dataset.id = String(w.lang_word_id);

        const span = document.createElement("span");
        span.textContent = `${w.word} (id ${w.lang_word_id})`;

        label.appendChild(cb);
        label.appendChild(span);
        allWordsEl.appendChild(label);
      }
    }

    async function saveLangPatch(patch) {
      const key = getAdminKey();
      const r = await fetch(`/api/langs/${encodeURIComponent(langId)}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", "Accept": "application/json", "X-Admin-Key": key },
        body: JSON.stringify(patch)
      });
      if (!r.ok) {
        const err = await r.json().catch(() => ({}));
        throw new Error(err.error || `save failed (${r.status})`);
      }
      return r.json();
    }

    listToggleBtn.addEventListener("click", async () => { setListMode(!listMode); if (!cachedWords.length) await refreshWords(); });
    sentencesBtn.addEventListener("click", () => { window.open("lang_sentences.html", "_blank", "noopener,noreferrer"); });

    adminBtn.addEventListener("click", async () => {
      const key = prompt("Admin key (stored locally):", getAdminKey() || "");
      if (!key || !key.trim()) return;
      setAdminKey(key.trim());
      await verifyAdminKey();
      setAdminUI();
    });

    manageBtn.addEventListener("click", async () => {
      if (!adminVerified) return;
      allWords = await fetchAllWords();
      renderAllWordsChecklist();
      openPanel();
    });

    overlay.addEventListener("click", closePanel);
    closePanelBtn.addEventListener("click", closePanel);

    saveNameBtn.addEventListener("click", async () => {
      saveNameMsg.textContent = "";
      if (!adminVerified) { saveNameMsg.textContent = "admin key required"; return; }
      const name = nameInput.value.trim();
      if (!name) return;
      try { await saveLangPatch({ name }); saveNameMsg.textContent = "saved"; await refreshWords(); }
      catch (e) { saveNameMsg.textContent = e.message || String(e); }
    });

    saveWordsBtn.addEventListener("click", async () => {
      saveWordsMsg.textContent = "";
      if (!adminVerified) { saveWordsMsg.textContent = "admin key required"; return; }
      const cbs = Array.from(allWordsEl.querySelectorAll('input[type="checkbox"]'));
      const ids = cbs.filter(x => x.checked).map(x => Number(x.dataset.id)).filter(x => Number.isInteger(x) && x > 0);
      try { await saveLangPatch({ lang_word_ids: ids }); saveWordsMsg.textContent = `saved ${ids.length} word(s)`; await refreshWords(); }
      catch (e) { saveWordsMsg.textContent = e.message || String(e); }
    });

    (async () => { await verifyAdminKey(); setAdminUI(); await refreshWords(); })();
  </script>
</body>
</html>