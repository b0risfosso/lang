<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>sentences</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; margin: 0; line-height: 1.4; }
    header { padding: 14px 16px; border-bottom: 1px solid color-mix(in oklab, currentColor 22%, transparent); display:flex; gap:12px; align-items:baseline; justify-content:space-between; }
    header h1 { font-size: 18px; margin: 0; }
    header nav a { margin-right: 10px; }
    a { text-decoration: none; border-bottom: 1px solid currentColor; }
    main { max-width: 76rem; margin: 0 auto; padding: 16px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .muted { opacity: .75; }
    .pill { display:inline-block; border: 1px solid color-mix(in oklab, currentColor 60%, transparent); border-radius: 999px; padding: 2px 10px; font-size: 12px; }
    button { font: inherit; padding: 8px 10px; border-radius: 10px; border: 1px solid color-mix(in oklab, currentColor 30%, transparent); background: transparent; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    input, textarea { font: inherit; padding: 8px 10px; border-radius: 10px; border: 1px solid color-mix(in oklab, currentColor 30%, transparent); background: transparent; }
    textarea { width: 100%; min-height: 80px; resize: vertical; }
    details { border: 1px solid color-mix(in oklab, currentColor 18%, transparent); border-radius: 14px; padding: 10px 12px; margin: 10px 0; }
    summary { cursor: pointer; user-select: none; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }
    .card { border: 1px solid color-mix(in oklab, currentColor 18%, transparent); border-radius: 14px; padding: 12px; }
    .tiny { font-size: 12px; }
    ul { margin: 8px 0; padding-left: 18px; }
    li { margin: 4px 0; }
  </style>
</head>
<body>
<header>
  <div class="row">
    <span class="pill" id="metaPill">…</span>
  </div>
  <nav class="tiny">
    <a href="./">home</a>
    <a href="write.html">write</a>
  </nav>
</header>

<main>
  words and stars
</main>

<script>
  const $ = (id) => document.getElementById(id);

  function getAdminKey() {
    return localStorage.getItem("lang_admin_key") || "";
  }
  function withAdminHeaders(h = {}) {
    const k = getAdminKey();
    if (k) h["X-Admin-Key"] = k;
    return h;
  }

  async function apiGet(url, { admin = false } = {}) {
    const headers = { "Accept": "application/json" };
    if (admin) Object.assign(headers, withAdminHeaders());
    const res = await fetch(url, { headers });
    if (!res.ok) throw new Error(`GET ${url} failed (${res.status})`);
    return await res.json();
  }

  async function apiPost(url, body, { admin = false } = {}) {
    const headers = { "Content-Type": "application/json", "Accept": "application/json" };
    if (admin) Object.assign(headers, withAdminHeaders());
    const res = await fetch(url, { method: "POST", headers, body: JSON.stringify(body || {}) });
    const txt = await res.text();
    let data = null;
    try { data = txt ? JSON.parse(txt) : null; } catch { data = null; }
    if (!res.ok) throw new Error((data && (data.description || data.error)) || `POST ${url} failed (${res.status})`);
    return data;
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  const selected = new Set();
  let words = [];
  let sentences = [];

  function updateSelectedUI() {
    $("selectedPill").textContent = `${selected.size} selected`;
    renderSentences();
  }

  async function refreshAdminStatus() {
    const k = getAdminKey();
    if (!k) { $("adminStatus").textContent = "admin: no key"; return false; }
    try {
      await apiGet("/api/admin/ping", { admin: true });
      $("adminStatus").textContent = "admin: ok";
      return true;
    } catch {
      $("adminStatus").textContent = "admin: invalid";
      return false;
    }
  }

  async function loadWords() {
    const data = await apiGet("/api/lang_words");
    words = Array.isArray(data.words) ? data.words : [];
    renderWords();
  }

  function renderWords() {
    const host = $("wordList");
    host.innerHTML = "";

    // simple searchable list (filter client-side)
    const search = document.createElement("input");
    search.placeholder = "search words…";
    search.style.width = "100%";
    host.appendChild(search);

    const list = document.createElement("div");
    list.style.marginTop = "10px";
    host.appendChild(list);

    function draw() {
      list.innerHTML = "";
      const q = (search.value || "").toLowerCase().trim();
      const filtered = words.filter(w => !q || String(w.word || "").toLowerCase().includes(q)).slice(0, 500);

      const meta = document.createElement("div");
      meta.className = "muted tiny";
      meta.textContent = `${filtered.length} shown`;
      list.appendChild(meta);

      const ul = document.createElement("ul");
      for (const w of filtered) {
        const li = document.createElement("li");
        const id = w.lang_word_id;
        const on = selected.has(id);

        const b = document.createElement("button");
        b.type = "button";
        b.textContent = on ? "✓" : "+";
        b.style.padding = "2px 8px";
        b.style.borderRadius = "999px";
        b.onclick = () => {
          if (selected.has(id)) selected.delete(id);
          else selected.add(id);
          updateSelectedUI();
        };

        const label = document.createElement("span");
        label.style.marginLeft = "8px";
        label.textContent = `${w.word} (id ${id})`;

        li.appendChild(b);
        li.appendChild(label);
        ul.appendChild(li);
      }
      list.appendChild(ul);
    }

    search.addEventListener("input", draw);
    draw();
  }

  async function loadSentences() {
    const data = await apiGet("/api/lang_sentences");
    sentences = Array.isArray(data.sentences) ? data.sentences : [];
    $("metaPill").textContent = `${sentences.length} total`;
    renderSentences();
  }

  function renderSentences() {
    const host = $("sentenceList");
    host.innerHTML = "";

    const need = Array.from(selected);
    const filtered = sentences.filter(s => {
      const ids = Array.isArray(s.lang_word_ids) ? s.lang_word_ids : [];
      for (const n of need) if (!ids.includes(n)) return false;
      return true;
    });

    $("resultMeta").textContent = `${filtered.length} match`;

    for (const s of filtered) {
      const card = document.createElement("div");
      card.className = "card";
      card.style.marginBottom = "10px";

      const ids = Array.isArray(s.lang_word_ids) ? s.lang_word_ids : [];
      card.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div><strong><a href="sentence.html?sentence_id=${s.id}">#${s.id}</a></strong> <span class="muted tiny">updated ${escapeHtml(s.updated_at || "")}</span></div>
          <span class="pill">${ids.length} word(s)</span>
        </div>
        <div style="margin-top:8px;">${escapeHtml(s.sentence || "")}</div>
        <div class="muted tiny" style="margin-top:8px;">lang_word_ids: ${escapeHtml(JSON.stringify(ids))}</div>
      `;
      host.appendChild(card);
    }

    if (!filtered.length) {
      const p = document.createElement("div");
      p.className = "muted tiny";
      p.textContent = "no matching sentences";
      host.appendChild(p);
    }
  }

  $("refreshWordsBtn").onclick = () => loadWords();
  $("refreshSentencesBtn").onclick = () => loadSentences();
  $("clearSelectionBtn").onclick = () => { selected.clear(); updateSelectedUI(); };



  async function boot() {
    await refreshAdminStatus();
    await loadWords();
    await loadSentences();
    updateSelectedUI();
  }

  boot().catch(err => console.error(err));
</script>
</body>
</html>