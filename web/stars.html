<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>stars</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; margin: 0; line-height: 1.4; }
    header { padding: 14px 16px; border-bottom: 1px solid color-mix(in oklab, currentColor 22%, transparent); display:flex; gap:12px; align-items:baseline; justify-content:space-between; }
    header h1 { font-size: 18px; margin: 0; }
    header nav a { margin-right: 10px; }
    a { text-decoration: none; border-bottom: 1px solid currentColor; }
    main { max-width: 76rem; margin: 0 auto; padding: 16px; }
    .grid { display:grid; grid-template-columns: 1fr 1.2fr; gap: 14px; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }
    .card { border: 1px solid color-mix(in oklab, currentColor 18%, transparent); border-radius: 14px; padding: 12px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .muted { opacity: .75; }
    .pill { display:inline-block; border: 1px solid color-mix(in oklab, currentColor 60%, transparent); border-radius: 999px; padding: 2px 10px; font-size: 12px; }
    button { font: inherit; padding: 8px 10px; border-radius: 10px; border: 1px solid color-mix(in oklab, currentColor 30%, transparent); background: transparent; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    textarea { width: 100%; min-height: 90px; resize: vertical; font: inherit; padding: 8px 10px; border-radius: 10px; border: 1px solid color-mix(in oklab, currentColor 30%, transparent); background: transparent; }
    .tiny { font-size: 12px; }
    details { border: 1px solid color-mix(in oklab, currentColor 18%, transparent); border-radius: 14px; padding: 10px 12px; margin: 10px 0; }
    summary { cursor: pointer; user-select: none; }
    pre { white-space: pre-wrap; word-break: break-word; margin: 8px 0 0; font-size: 12px; opacity: .95; }
    .danger { border-color: color-mix(in oklab, red 55%, currentColor 18%); }
    code.inline { padding: 2px 6px; border-radius: 8px; border: 1px solid color-mix(in oklab, currentColor 18%, transparent); }
    .checkboxes label { display:flex; gap:10px; align-items:center; margin: 6px 0; }
  </style>
</head>
<body>
<header>
  <div class="row">
    <h1>stars</h1>
    <span class="pill" id="childPill">child_word_id: …</span>
  </div>
  <nav class="tiny">
    <a href="./">home</a>
    <a href="write.html">write</a>
    <a href="lang.html">sentences</a>
  </nav>
</header>

<main>
  <div class="grid">
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <strong>context</strong>
        <span class="muted tiny" id="adminStatus">admin: unknown</span>
      </div>

      <div style="margin-top:10px;">
        <div class="muted tiny">lang name</div>
        <div><strong id="langName">—</strong></div>
      </div>

      <div style="margin-top:10px;">
        <div class="muted tiny">lang word</div>
        <div><strong id="langWord">—</strong> <span class="muted tiny" id="langWordMeta"></span></div>
      </div>

      <div style="margin-top:10px;">
        <div class="muted tiny">child word</div>
        <div class="row">
          <strong id="childWord">—</strong>
          <a id="childLink" class="muted tiny" target="_blank" rel="noopener noreferrer" style="display:none;">source</a>
        </div>
      </div>

      <details style="margin-top:14px;" open>
        <summary><strong>star stuff</strong> <span class="muted tiny">generate LLM artifacts into the queue</span></summary>

        <div style="margin-top:10px;">
          <div class="muted tiny">optional modifier</div>
          <textarea id="modifierInput" placeholder="optional modifier…"></textarea>
        </div>

        <div class="checkboxes" style="margin-top:10px;">
          <div class="muted tiny">select prompts</div>
          <label><input type="checkbox" value="create_star_stuff_words" checked /> create_star_stuff_words</label>
          <label><input type="checkbox" value="create_star_stuff_images" /> create_star_stuff_images</label>
          <label><input type="checkbox" value="create_star_stuff_data" /> create_star_stuff_data</label>
          <label><input type="checkbox" value="create_star_stuff_synthetic_data" /> create_star_stuff_synthetic_data</label>
          <label><input type="checkbox" value="create_star_stuff_code" /> create_star_stuff_code</label>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="runBtn" type="button" disabled>enqueue selected</button>
          <button id="refreshBtn" type="button">refresh</button>
          <span class="pill" id="taskPill">idle</span>
        </div>

        <div class="muted tiny" style="margin-top:6px;">
          Requires admin key in localStorage <code class="inline">lang_admin_key</code>.
        </div>
      </details>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <strong>existing star stuff</strong>
        <span class="muted tiny" id="meta">…</span>
      </div>
      <div id="stuff" style="margin-top:10px;"></div>
    </section>
  </div>
</main>

<script>
  const $ = (id) => document.getElementById(id);

  function getAdminKey() { return localStorage.getItem("lang_admin_key") || ""; }
  function withAdminHeaders(h = {}) { const k = getAdminKey(); if (k) h["X-Admin-Key"] = k; return h; }

  async function apiGet(url, { admin = false } = {}) {
    const headers = { "Accept": "application/json" };
    if (admin) Object.assign(headers, withAdminHeaders());
    const res = await fetch(url, { headers });
    if (!res.ok) throw new Error(`GET ${url} failed (${res.status})`);
    return await res.json();
  }

  async function apiPost(url, body, { admin = false } = {}) {
    const headers = { "Content-Type": "application/json", "Accept": "application/json" };
    if (admin) Object.assign(headers, withAdminHeaders());
    const res = await fetch(url, { method: "POST", headers, body: JSON.stringify(body || {}) });
    const txt = await res.text();
    let data = null;
    try { data = txt ? JSON.parse(txt) : null; } catch { data = null; }
    if (!res.ok) throw new Error((data && (data.description || data.error)) || `POST ${url} failed (${res.status})`);
    return data;
  }

  function escapeHtml(s) {
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function getChildWordId() {
    const u = new URL(location.href);
    const v = u.searchParams.get("child_word_id");
    return v ? Number(v) : 0;
  }

  async function refreshAdminStatus() {
    const k = getAdminKey();
    if (!k) { $("adminStatus").textContent = "admin: no key"; return false; }
    try { await apiGet("/api/admin/ping", { admin: true }); $("adminStatus").textContent = "admin: ok"; return true; }
    catch { $("adminStatus").textContent = "admin: invalid"; return false; }
  }

  function selectedPrompts() {
    return Array.from(document.querySelectorAll('input[type="checkbox"]')).filter(x => x.checked).map(x => x.value);
  }

  async function pollTask(taskId) {
    $("taskPill").textContent = "running";
    while (true) {
      const t = await apiGet(`/api/tasks/${taskId}`);
      if (t.status === "done") return t;
      if (t.status === "error") throw new Error(t.error || "task failed");
      await new Promise(r => setTimeout(r, 1200));
    }
  }

  async function loadPage() {
    const childId = getChildWordId();
    if (!childId) {
      $("stuff").innerHTML = `<div class="card danger">Missing child_word_id in URL (expected ?child_word_id=...)</div>`;
      $("runBtn").disabled = true;
      return;
    }

    $("childPill").textContent = `child_word_id: ${childId}`;
    const data = await apiGet(`/api/stars?child_word_id=${encodeURIComponent(childId)}`);

    $("langName").textContent = data.lang_name && data.lang_name.word ? data.lang_name.word : "—";
    $("langWord").textContent = data.lang_word.word || "—";
    $("langWordMeta").textContent = data.lang_word.version ? `(v${data.lang_word.version})` : "";
    $("childWord").textContent = data.child_word.word || "—";

    if (data.child_word.link) {
      $("childLink").style.display = "";
      $("childLink").href = data.child_word.link;
      $("childLink").textContent = "source";
    } else {
      $("childLink").style.display = "none";
    }

    renderStuff(data.star_stuff || []);
  }

  function renderStuff(items) {
    $("meta").textContent = `${items.length} item(s)`;
    const host = $("stuff");
    host.innerHTML = "";
    if (!items.length) { host.innerHTML = `<div class="muted tiny">No star stuff yet for this child word.</div>`; return; }

    const groups = {};
    for (const it of items) {
      groups[it.prompt_type] = groups[it.prompt_type] || [];
      groups[it.prompt_type].push(it);
    }

    for (const [ptype, arr] of Object.entries(groups)) {
      const d = document.createElement("details");
      d.open = false;
      const s = document.createElement("summary");
      s.innerHTML = `<strong>${escapeHtml(ptype)}</strong> <span class="muted tiny">(${arr.length})</span>`;
      d.appendChild(s);

      for (const it of arr) {
        const card = document.createElement("div");
        card.className = "card";
        card.style.marginTop = "10px";
        card.innerHTML = `
          <div class="row" style="justify-content:space-between;">
            <div><strong>#${it.id}</strong> <span class="muted tiny">task ${it.task_id ?? "—"} • ${escapeHtml(it.created_at || "")}</span></div>
            ${it.modifier ? `<span class="pill">modifier</span>` : `<span class="pill muted">no modifier</span>`}
          </div>
          ${it.modifier ? `<div class="muted tiny" style="margin-top:6px;">${escapeHtml(it.modifier)}</div>` : ""}
          <pre>${escapeHtml(it.text || "")}</pre>
        `;
        d.appendChild(card);
      }
      host.appendChild(d);
    }
  }

  $("refreshBtn").onclick = () => loadPage();

  $("runBtn").onclick = async () => {
    const childId = getChildWordId();
    const prompts = selectedPrompts();
    if (!prompts.length) { alert("Select at least one prompt."); return; }

    try {
      $("runBtn").disabled = true;
      $("taskPill").textContent = "queued";
      const res = await apiPost("/api/star_stuff/tasks", {
        child_word_id: childId,
        prompts,
        modifier: ($("modifierInput").value || "").trim()
      }, { admin: true });

      const ids = res.task_ids || [];
      for (const id of ids) await pollTask(id);
      $("taskPill").textContent = "done";
      await loadPage();
    } catch (e) {
      $("taskPill").textContent = "error";
      alert(String(e.message || e));
    } finally {
      $("runBtn").disabled = !(getAdminKey());
    }
  };

  async function boot() {
    await refreshAdminStatus();
    $("runBtn").disabled = !(getAdminKey());
    await loadPage();
  }

  boot().catch(err => {
    console.error(err);
    $("stuff").innerHTML = `<div class="card danger">${escapeHtml(String(err.message || err))}</div>`;
  });
</script>
</body>
</html>
