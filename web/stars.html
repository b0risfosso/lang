<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>stars</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; margin: 0; line-height: 1.4; }
    header { padding: 14px 16px; border-bottom: 1px solid color-mix(in oklab, currentColor 22%, transparent); display:flex; gap:12px; align-items:baseline; justify-content:space-between; }
    header h1 { font-size: 18px; margin: 0; }
    header nav a { margin-right: 10px; }
    a { text-decoration: none; border-bottom: 1px solid currentColor; }
    main { max-width: 76rem; margin: 0 auto; padding: 16px; }
    .grid { display:grid; grid-template-columns: 1fr 1.2fr; gap: 14px; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }
    .card { border: 1px solid color-mix(in oklab, currentColor 18%, transparent); border-radius: 14px; padding: 12px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .muted { opacity: .75; }
    .pill { display:inline-block; border: 1px solid color-mix(in oklab, currentColor 60%, transparent); border-radius: 999px; padding: 2px 10px; font-size: 12px; }
    button { font: inherit; padding: 8px 10px; border-radius: 10px; border: 1px solid color-mix(in oklab, currentColor 30%, transparent); background: transparent; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    textarea { width: 100%; min-height: 90px; resize: vertical; font: inherit; padding: 8px 10px; border-radius: 10px; border: 1px solid color-mix(in oklab, currentColor 30%, transparent); background: transparent; }
    .tiny { font-size: 12px; }
    details { border: 1px solid color-mix(in oklab, currentColor 18%, transparent); border-radius: 14px; padding: 10px 12px; margin: 10px 0; }
    summary { cursor: pointer; user-select: none; }
    pre { white-space: pre-wrap; word-break: break-word; margin: 8px 0 0; font-size: 12px; opacity: .95; }
    .danger { border-color: color-mix(in oklab, red 55%, currentColor 18%); }
    code.inline { padding: 2px 6px; border-radius: 8px; border: 1px solid color-mix(in oklab, currentColor 18%, transparent); }
    .checkboxes label { display:flex; gap:10px; align-items:center; margin: 6px 0; }
  </style>
</head>
<body>
<header>
  <div class="row">
    <h1>stars</h1>
    <span class="pill" id="adminStatus">admin: unknown</span>
  </div>
  <nav class="tiny">
    <a href="./">home</a>
    <a href="write.html">write</a>
    <a href="lang.html">sentences</a>
  </nav>
</header>

<main>
  <div class="grid">
    <!-- LEFT PANEL: Word Tree -->
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <strong>word tree</strong>
        <button id="refreshTreeBtn" type="button">refresh</button>
      </div>
      <div id="wordTree" style="margin-top:10px;"></div>
    </section>

    <!-- RIGHT PANEL: Selected Child Words -->
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <strong>selected child words</strong>
        <span class="muted tiny" id="selectedCount">0 selected</span>
      </div>
      <div id="selectedPanel" style="margin-top:10px;"></div>

      <!-- Enqueue Section -->
      <details style="margin-top:14px;" open>
        <summary><strong>enqueue star stuff</strong> <span class="muted tiny">for selected child words</span></summary>

        <div style="margin-top:10px;">
          <div class="muted tiny">optional modifier</div>
          <textarea id="modifierInput" placeholder="optional modifier…"></textarea>
        </div>

        <div class="checkboxes" style="margin-top:10px;">
          <div class="muted tiny">select prompts</div>
          <label><input type="checkbox" value="create_star_stuff_words" checked /> create_star_stuff_words</label>
          <label><input type="checkbox" value="create_star_stuff_images" /> create_star_stuff_images</label>
          <label><input type="checkbox" value="create_star_stuff_data" /> create_star_stuff_data</label>
          <label><input type="checkbox" value="create_star_stuff_synthetic_data" /> create_star_stuff_synthetic_data</label>
          <label><input type="checkbox" value="create_star_stuff_code" /> create_star_stuff_code</label>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="enqueueBtn" type="button" disabled>enqueue for selected</button>
          <span class="pill" id="taskPill">idle</span>
        </div>

        <div class="muted tiny" style="margin-top:6px;">
          Requires admin key in localStorage <code class="inline">lang_admin_key</code>.
        </div>
      </details>
    </section>
  </div>
</main>

<script>
  const $ = (id) => document.getElementById(id);

  let roots = [];
  let selectedChildWordIds = new Set();
  let childWordData = new Map(); // id -> data from /api/stars

  function getAdminKey() { return localStorage.getItem("lang_admin_key") || ""; }
  function withAdminHeaders(h = {}) { const k = getAdminKey(); if (k) h["X-Admin-Key"] = k; return h; }

  async function apiGet(url, { admin = false } = {}) {
    const headers = { "Accept": "application/json" };
    if (admin) Object.assign(headers, withAdminHeaders());
    const res = await fetch(url, { headers });
    if (!res.ok) throw new Error(`GET ${url} failed (${res.status})`);
    return await res.json();
  }

  async function apiPost(url, body, { admin = false } = {}) {
    const headers = { "Content-Type": "application/json", "Accept": "application/json" };
    if (admin) Object.assign(headers, withAdminHeaders());
    const res = await fetch(url, { method: "POST", headers, body: JSON.stringify(body || {}) });
    const txt = await res.text();
    let data = null;
    try { data = txt ? JSON.parse(txt) : null; } catch { data = null; }
    if (!res.ok) throw new Error((data && (data.description || data.error)) || `POST ${url} failed (${res.status})`);
    return data;
  }

  function escapeHtml(s) {
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function getUrlChildWordId() {
    const u = new URL(location.href);
    const v = u.searchParams.get("child_word_id");
    return v ? Number(v) : 0;
  }

  async function refreshAdminStatus() {
    const k = getAdminKey();
    if (!k) { $("adminStatus").textContent = "admin: no key"; return false; }
    try { await apiGet("/api/admin/ping", { admin: true }); $("adminStatus").textContent = "admin: ok"; return true; }
    catch { $("adminStatus").textContent = "admin: invalid"; return false; }
  }

  function selectedPrompts() {
    return Array.from(document.querySelectorAll('input[type="checkbox"]')).filter(x => x.checked).map(x => x.value);
  }

  async function pollTask(taskId) {
    while (true) {
      const t = await apiGet(`/api/tasks/${taskId}`);
      if (t.status === "done") return t;
      if (t.status === "error") throw new Error(t.error || "task failed");
      await new Promise(r => setTimeout(r, 1200));
    }
  }

  async function loadRoots() {
    roots = await apiGet("/api/write");
    renderWordTree();
  }

  function renderWordTree() {
    const host = $("wordTree");
    host.innerHTML = "";

    if (!Array.isArray(roots)) roots = [];

    for (const R of roots) {
      const d = document.createElement("details");
      d.open = false;

      const s = document.createElement("summary");
      s.innerHTML = `<strong>${escapeHtml(R.word)}</strong> <span class="muted tiny">(parent id ${R.lang_word_id})</span>`;
      d.appendChild(s);

      // Child lang words
      const childLangWords = Array.isArray(R.current_child_lang_words) ? R.current_child_lang_words : [];
      if (childLangWords.length) {
        const ul = document.createElement("ul");
        for (const clw of childLangWords) {
          const li = document.createElement("li");
          li.innerHTML = `<strong>${escapeHtml(clw.word)}</strong> <span class="muted tiny">(id ${clw.lang_word_id})</span>`;
          ul.appendChild(li);

          // Now child words under this lang word
          // I need to get child words for this lang word's latest version
          // But /api/write gives child_lang_words, but not their child_words directly.
          // The roots have versions, each version has child_words.
          // For current, it's R.versions[0].child_words if exists.
          const latest = R.versions && R.versions.length ? R.versions[0] : null;
          if (latest && Array.isArray(latest.child_words)) {
            const subUl = document.createElement("ul");
            for (const cw of latest.child_words) {
              const subLi = document.createElement("li");
              const label = document.createElement("label");
              label.style.display = "flex";
              label.style.alignItems = "center";
              label.style.gap = "8px";

              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.value = cw.id;
              checkbox.checked = selectedChildWordIds.has(cw.id);
              checkbox.onchange = () => {
                if (checkbox.checked) {
                  selectedChildWordIds.add(cw.id);
                } else {
                  selectedChildWordIds.delete(cw.id);
                }
                updateSelectedCount();
                renderSelectedPanel();
              };

              const span = document.createElement("span");
              span.innerHTML = `<strong>${escapeHtml(cw.word)}</strong> <span class="muted tiny">(id ${cw.id})</span>`;

              label.appendChild(checkbox);
              label.appendChild(span);
              subLi.appendChild(label);
              subUl.appendChild(subLi);
            }
            li.appendChild(subUl);
          }
        }
        d.appendChild(ul);
      }

      host.appendChild(d);
    }
  }

  function updateSelectedCount() {
    $("selectedCount").textContent = `${selectedChildWordIds.size} selected`;
    $("enqueueBtn").disabled = selectedChildWordIds.size === 0 || !getAdminKey();
  }

  async function renderSelectedPanel() {
    const host = $("selectedPanel");
    host.innerHTML = "";

    if (selectedChildWordIds.size === 0) {
      host.innerHTML = `<div class="muted tiny">Select child words from the left panel.</div>`;
      return;
    }

    for (const childId of selectedChildWordIds) {
      if (!childWordData.has(childId)) {
        try {
          const data = await apiGet(`/api/stars?child_word_id=${encodeURIComponent(childId)}`);
          childWordData.set(childId, data);
        } catch (e) {
          console.error(`Failed to load data for child_word ${childId}:`, e);
          continue;
        }
      }

      const data = childWordData.get(childId);
      const card = document.createElement("div");
      card.className = "card";
      card.style.marginBottom = "10px";

      card.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div>
            <strong>${escapeHtml(data.child_word.word || "—")}</strong>
            <span class="muted tiny">(id ${data.child_word.id})</span>
            ${data.child_word.link ? `<a href="${escapeHtml(data.child_word.link)}" target="_blank" rel="noopener noreferrer" class="muted tiny">source</a>` : ""}
          </div>
          <div class="muted tiny">${escapeHtml(data.lang_name.word || "—")} / ${escapeHtml(data.lang_word.word || "—")}</div>
        </div>
        <div id="stuff-${childId}" style="margin-top:10px;"></div>
      `;

      renderStuffForChild(card.querySelector(`#stuff-${childId}`), data.star_stuff || []);
      host.appendChild(card);
    }
  }

  function renderStuffForChild(host, items) {
    host.innerHTML = "";
    if (!items.length) {
      host.innerHTML = `<div class="muted tiny">No star stuff yet.</div>`;
      return;
    }

    const groups = {};
    for (const it of items) {
      groups[it.prompt_type] = groups[it.prompt_type] || [];
      groups[it.prompt_type].push(it);
    }

    for (const [ptype, arr] of Object.entries(groups)) {
      const d = document.createElement("details");
      d.open = false;
      const s = document.createElement("summary");
      s.innerHTML = `<strong>${escapeHtml(ptype)}</strong> <span class="muted tiny">(${arr.length})</span>`;
      d.appendChild(s);

      for (const it of arr) {
        const itemCard = document.createElement("div");
        itemCard.className = "card";
        itemCard.style.marginTop = "10px";
        itemCard.innerHTML = `
          <div class="row" style="justify-content:space-between;">
            <div><strong>#${it.id}</strong> <span class="muted tiny">task ${it.task_id ?? "—"} • ${escapeHtml(it.created_at || "")}</span></div>
            ${it.modifier ? `<span class="pill">modifier</span>` : `<span class="pill muted">no modifier</span>`}
          </div>
          ${it.modifier ? `<div class="muted tiny" style="margin-top:6px;">${escapeHtml(it.modifier)}</div>` : ""}
          <pre>${escapeHtml(it.text || "")}</pre>
        `;
        d.appendChild(itemCard);
      }
      host.appendChild(d);
    }
  }

  async function enqueueForSelected() {
    const prompts = selectedPrompts();
    if (!prompts.length) { alert("Select at least one prompt."); return; }
    if (selectedChildWordIds.size === 0) { alert("Select at least one child word."); return; }

    const modifier = ($("modifierInput").value || "").trim();

    try {
      $("enqueueBtn").disabled = true;
      $("taskPill").textContent = "enqueuing";

      const taskIds = [];
      for (const childId of selectedChildWordIds) {
        const res = await apiPost("/api/star_stuff/tasks", {
          child_word_id: childId,
          prompts,
          modifier
        }, { admin: true });
        taskIds.push(...(res.task_ids || []));
      }

      for (const id of taskIds) await pollTask(id);
      $("taskPill").textContent = "done";

      // Refresh data for selected
      for (const childId of selectedChildWordIds) {
        childWordData.delete(childId);
      }
      await renderSelectedPanel();
    } catch (e) {
      $("taskPill").textContent = "error";
      alert(String(e.message || e));
    } finally {
      updateSelectedCount();
    }
  }

  async function boot() {
    await refreshAdminStatus();
    await loadRoots();

    const urlChildId = getUrlChildWordId();
    if (urlChildId) {
      selectedChildWordIds.add(urlChildId);
      updateSelectedCount();
      await renderSelectedPanel();
    }

    updateSelectedCount();
  }

  $("refreshTreeBtn").onclick = () => loadRoots();
  $("enqueueBtn").onclick = () => enqueueForSelected();

  boot().catch(err => {
    console.error(err);
    $("selectedPanel").innerHTML = `<div class="card danger">${escapeHtml(String(err.message || err))}</div>`;
  });
</script>
</body>
</html>
