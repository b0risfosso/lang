<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>sentence</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; margin: 0; line-height: 1.4; }
    header { padding: 14px 16px; border-bottom: 1px solid color-mix(in oklab, currentColor 22%, transparent); display:flex; gap:12px; align-items:baseline; justify-content:space-between; }
    header h1 { font-size: 18px; margin: 0; }
    header nav a { margin-right: 10px; }
    a { text-decoration: none; border-bottom: 1px solid currentColor; }
    main { max-width: 76rem; margin: 0 auto; padding: 16px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .muted { opacity: .75; }
    .pill { display:inline-block; border: 1px solid color-mix(in oklab, currentColor 60%, transparent); border-radius: 999px; padding: 2px 10px; font-size: 12px; }
    button { font: inherit; padding: 8px 10px; border-radius: 10px; border: 1px solid color-mix(in oklab, currentColor 30%, transparent); background: transparent; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    input { font: inherit; padding: 8px 10px; border-radius: 10px; border: 1px solid color-mix(in oklab, currentColor 30%, transparent); background: transparent; }
    details { border: 1px solid color-mix(in oklab, currentColor 18%, transparent); border-radius: 14px; padding: 10px 12px; margin: 10px 0; }
    details details { margin: 8px 0 0; }
    summary { cursor: pointer; user-select: none; }
    ul { margin: 8px 0; padding-left: 18px; }
    li { margin: 4px 0; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }
    .card { border: 1px solid color-mix(in oklab, currentColor 18%, transparent); border-radius: 14px; padding: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .tiny { font-size: 12px; }
    .loading { opacity: .8; font-style: italic; }
    .indent { margin-left: 14px; border-left: 2px solid color-mix(in oklab, currentColor 12%, transparent); padding-left: 12px; }
  </style>
</head>
<body>
<header>
  <div class="row">
    <h1>sentence</h1>
    <span class="pill" id="metaPill">…</span>
  </div>
  <nav class="tiny">
    <a href="./">home</a>
    <a href="write.html">write</a>
    <a href="lang.html">sentences</a>
  </nav>
</header>

<main>
  <div class="grid">
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <strong>sentence</strong>
        <div class="row">
          <input id="sentenceIdInput" placeholder="sentence id…" style="width:140px;" />
          <button id="goBtn" type="button">open</button>
        </div>
      </div>
      <div class="muted tiny" id="sentenceMeta">…</div>
      <div style="margin-top:10px;" id="sentenceText" class="mono"></div>
      <div style="margin-top:10px;" class="muted tiny mono" id="sentenceIds"></div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <strong>lang words</strong>
        <span class="muted tiny" id="wordsMeta">…</span>
      </div>
      <div id="wordsHost" style="margin-top:10px;"></div>
    </section>
  </div>
</main>

<script>
  const $ = (id) => document.getElementById(id);

  function esc(s) {
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function getParam(name) {
    const u = new URL(window.location.href);
    return u.searchParams.get(name);
  }

  function setParam(name, value) {
    const u = new URL(window.location.href);
    if (value === null || value === undefined || value === "") u.searchParams.delete(name);
    else u.searchParams.set(name, String(value));
    history.pushState({}, "", u.toString());
  }

  async function apiGet(url) {
    const res = await fetch(url, { headers: { "Accept": "application/json" } });
    if (!res.ok) throw new Error(`GET ${url} failed (${res.status})`);
    return await res.json();
  }

  let wordsIndex = new Map(); // lang_word_id -> {word, latest_version_id, ...}

  async function loadWordsIndex() {
    const data = await apiGet("/api/lang_words");
    const arr = Array.isArray(data.words) ? data.words : [];
    wordsIndex = new Map(arr.map(w => [Number(w.lang_word_id), w]));
  }

  async function loadSentence(sentenceId) {
    $("metaPill").textContent = `#${sentenceId}`;
    $("sentenceMeta").textContent = "loading…";
    $("sentenceText").innerHTML = `<span class="loading">loading…</span>`;
    $("sentenceIds").textContent = "";
    $("wordsHost").innerHTML = "";

    const s = await apiGet(`/api/lang_sentences/${sentenceId}`);
    const ids = Array.isArray(s.lang_word_ids) ? s.lang_word_ids : [];

    $("sentenceMeta").textContent = `updated ${s.updated_at || ""}`;
    $("sentenceText").innerHTML = esc(s.sentence || "");
    $("sentenceIds").innerHTML = `lang_word_ids: ${esc(JSON.stringify(ids))}`;
    $("sentenceIdInput").value = String(sentenceId);

    $("wordsMeta").textContent = `${ids.length} word(s)`;

    for (const wid of ids) {
      const node = renderLangWordNode(Number(wid), 0);
      $("wordsHost").appendChild(node);
    }

    if (!ids.length) {
      const p = document.createElement("div");
      p.className = "muted tiny";
      p.textContent = "no lang words linked to this sentence";
      $("wordsHost").appendChild(p);
    }
  }

  function renderLangWordNode(langWordId, depth) {
    const w = wordsIndex.get(langWordId);
    const label = w ? `${w.word} (id ${langWordId})` : `lang_word_id ${langWordId}`;
    const latestVersionId = w ? w.latest_version_id : null;

    const det = document.createElement("details");
    det.dataset.langWordId = String(langWordId);
    det.dataset.depth = String(depth);

    const sum = document.createElement("summary");
    sum.innerHTML = `<strong>${esc(label)}</strong> <span class="muted tiny">${latestVersionId ? `v_id ${latestVersionId}` : "no version"}</span>`;
    det.appendChild(sum);

    const inner = document.createElement("div");
    inner.className = depth ? "indent" : "";
    inner.innerHTML = `<div class="loading">expand to load…</div>`;
    det.appendChild(inner);

    let loaded = false;
    det.addEventListener("toggle", async () => {
      if (!det.open || loaded) return;
      loaded = true;

      if (!latestVersionId) {
        inner.innerHTML = `<div class="muted tiny">no version data</div>`;
        return;
      }

      try {
        inner.innerHTML = `<div class="loading">loading children…</div>`;
        const v = await apiGet(`/api/lang_words/${latestVersionId}`);

        const childLang = Array.isArray(v.child_lang_words) ? v.child_lang_words : [];
        const childWords = Array.isArray(v.child_words) ? v.child_words : [];

        const wrap = document.createElement("div");

        const sectionA = document.createElement("div");
        sectionA.className = "card";
        sectionA.style.marginTop = "10px";
        sectionA.innerHTML = `<div class="row" style="justify-content:space-between;"><strong>child lang words</strong><span class="pill">${childLang.length}</span></div>`;
        if (childLang.length) {
          const ul = document.createElement("ul");
          for (const cw of childLang) {
            const li = document.createElement("li");
            li.appendChild(renderLangWordNode(Number(cw.lang_word_id), depth + 1));
            ul.appendChild(li);
          }
          sectionA.appendChild(ul);
        } else {
          const p = document.createElement("div");
          p.className = "muted tiny";
          p.textContent = "none";
          sectionA.appendChild(p);
        }

        const sectionB = document.createElement("div");
        sectionB.className = "card";
        sectionB.style.marginTop = "10px";
        sectionB.innerHTML = `<div class="row" style="justify-content:space-between;"><strong>child words</strong><span class="pill">${childWords.length}</span></div>`;
        if (childWords.length) {
          const ul = document.createElement("ul");
          for (const c of childWords) {
            const li = document.createElement("li");
            const external = c.link ? ` • <a href="${esc(c.link)}" target="_blank" rel="noopener noreferrer">link</a>` : "";
            li.innerHTML = `<span>${esc(c.word)} <span class="muted tiny">(id ${esc(c.id)})</span></span>${external} • <a href="stars.html?child_word_id=${encodeURIComponent(c.id)}">stars</a>`;
            ul.appendChild(li);
          }
          sectionB.appendChild(ul);
        } else {
          const p = document.createElement("div");
          p.className = "muted tiny";
          p.textContent = "none";
          sectionB.appendChild(p);
        }

        wrap.appendChild(sectionA);
        wrap.appendChild(sectionB);
        inner.innerHTML = "";
        inner.appendChild(wrap);
      } catch (e) {
        inner.innerHTML = `<div class="muted tiny">error: ${esc(e.message || e)}</div>`;
      }
    });

    return det;
  }

  function parseSentenceId() {
    const raw = getParam("sentence_id") || "";
    const n = Number(raw);
    return Number.isFinite(n) && n > 0 ? Math.floor(n) : null;
  }

  $("goBtn").onclick = () => {
    const n = Number(($("sentenceIdInput").value || "").trim());
    if (!Number.isFinite(n) || n <= 0) return;
    setParam("sentence_id", Math.floor(n));
    boot().catch(err => console.error(err));
  };

  window.addEventListener("popstate", () => {
    boot().catch(err => console.error(err));
  });

  async function boot() {
    await loadWordsIndex();

    const sid = parseSentenceId();
    if (!sid) {
      $("metaPill").textContent = "no sentence_id";
      $("sentenceMeta").textContent = "add ?sentence_id=123 (or type an id above)";
      $("sentenceText").textContent = "";
      $("sentenceIds").textContent = "";
      $("wordsHost").innerHTML = `<div class="muted tiny">no sentence loaded</div>`;
      $("wordsMeta").textContent = "—";
      return;
    }

    try {
      await loadSentence(sid);
    } catch (e) {
      $("metaPill").textContent = `#${sid}`;
      $("sentenceMeta").textContent = "error";
      $("sentenceText").innerHTML = `<div class="muted tiny">error: ${esc(e.message || e)}</div>`;
      $("wordsHost").innerHTML = ``;
      $("wordsMeta").textContent = "—";
    }
  }

  boot().catch(err => console.error(err));
</script>
</body>
</html>
