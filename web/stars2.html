<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>stars</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; line-height: 1.5; }
    main { max-width: 56rem; margin: 10vh auto; }
    a { text-decoration: none; border-bottom: 1px solid currentColor; }
    .panel { border: 1px solid currentColor; border-radius: 1rem; padding: 1rem; margin-top: 1rem; }
    .panel h2 { font-size: 1rem; margin: 0 0 .75rem; }
    .muted { opacity: .75; }
    .big { font-size: 2rem; margin: .25rem 0 .35rem; }
    .row { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    .pill { border: 1px solid currentColor; border-radius: 999px; padding: .15rem .55rem; font-size: .85rem; }
    button, input, textarea, select { font: inherit; }
    button { cursor: pointer; border: 1px solid currentColor; background: transparent; border-radius: .6rem; padding: .35rem .6rem; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    textarea { width: 100%; min-height: 4.25rem; border-radius: .6rem; border: 1px solid currentColor; background: transparent; padding: .5rem .6rem; }
    .grid { display:grid; gap:.75rem; }
    .checks { display:grid; gap:.4rem; grid-template-columns: repeat(auto-fit, minmax(16rem, 1fr)); }
    .card { border: 1px solid currentColor; border-radius: .9rem; padding: .85rem; }
    pre { white-space: pre-wrap; word-break: break-word; margin: .6rem 0 0; }
    .hr { height: 1px; background: currentColor; opacity: .25; margin: .75rem 0; }
  </style>
</head>
<body>
  <main>
    <p style="margin:0 0 .5rem;"><a href="javascript:history.back()">← back</a></p>

    <div class="panel">
      <h2>star</h2>

      <div class="row" style="justify-content:space-between;">
        <div class="muted" id="meta">…</div>

        <div class="row">
          <span class="pill" id="mode-pill">view</span>
          <button id="admin-btn" type="button">enter admin key</button>
          <button id="clear-admin-btn" type="button" style="display:none;">clear key</button>
        </div>
      </div>

      <div class="big" id="child">—</div>

      <div class="row" style="margin-top:.25rem;">
        <span class="pill" id="langName">—</span>
        <a id="langWordLink" class="pill" href="#" target="_blank" rel="noopener">—</a>
      </div>
    </div>

    <div class="panel">
      <h2>star stuff</h2>

      <div class="grid" style="margin-bottom:.75rem;">
        <label class="muted" for="modifier">modifier (optional)</label>
        <textarea id="modifier" placeholder="e.g., technical, conceptual, comparative, UX-focused…"></textarea>

        <div class="checks" id="prompt-checks">
          <label><input type="checkbox" value="create_star_stuff_words" checked /> words (description)</label>
          <label><input type="checkbox" value="create_star_stuff_images" /> images (curation)</label>
          <label><input type="checkbox" value="create_star_stuff_data" /> data (real-world)</label>
          <label><input type="checkbox" value="create_star_stuff_synthetic_data" /> synthetic data</label>
          <label><input type="checkbox" value="create_star_stuff_code" /> code</label>
        </div>

        <div class="row">
          <button id="queue-btn" type="button">queue selected</button>
          <span class="muted" id="queue-status"></span>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid" style="gap:1rem;">
        <div>
          <div class="row" style="justify-content:space-between; align-items:baseline;">
            <div class="muted">tasks</div>
            <button id="refresh-btn" type="button">refresh</button>
          </div>
          <div id="tasks"></div>
        </div>

        <div>
          <div class="muted">existing star stuff</div>
          <div id="items" style="margin-top:.5rem;"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const ADMIN_KEY_STORAGE = "lang_admin_key";

    const params = new URLSearchParams(location.search);
    const childWordId = params.get("child_word_id");

    const metaEl = document.getElementById("meta");
    const childEl = document.getElementById("child");
    const langNameEl = document.getElementById("langName");
    const langWordLink = document.getElementById("langWordLink");
    const modePill = document.getElementById("mode-pill");

    const modifierEl = document.getElementById("modifier");
    const queueBtn = document.getElementById("queue-btn");
    const queueStatusEl = document.getElementById("queue-status");
    const itemsEl = document.getElementById("items");
    const tasksEl = document.getElementById("tasks");
    const refreshBtn = document.getElementById("refresh-btn");

    const adminBtn = document.getElementById("admin-btn");
    const clearAdminBtn = document.getElementById("clear-admin-btn");

    function getAdminKey() {
      return localStorage.getItem(ADMIN_KEY_STORAGE) || "";
    }

    function setAdminUI() {
      const has = !!getAdminKey();
      modePill.textContent = has ? "edit" : "view";
      clearAdminBtn.style.display = has ? "" : "none";
    }

    adminBtn.addEventListener("click", () => {
      const current = getAdminKey();
      const key = prompt("Admin key:", current || "");
      if (key === null) return;
      if (!key.trim()) return alert("No key provided.");
      localStorage.setItem(ADMIN_KEY_STORAGE, key.trim());
      setAdminUI();
    });

    clearAdminBtn.addEventListener("click", () => {
      localStorage.removeItem(ADMIN_KEY_STORAGE);
      setAdminUI();
    });

    function esc(s) {
      return String(s ?? "").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
    }

    async function loadStar() {
      if (!childWordId) {
        metaEl.textContent = "missing child_word_id";
        return;
      }

      const r = await fetch(`/api/stars?child_word_id=${encodeURIComponent(childWordId)}`, {
        headers: { "Accept": "application/json" }
      });

      if (!r.ok) {
        const err = await r.json().catch(() => ({}));
        metaEl.textContent = err.error || `not found (${r.status})`;
        return;
      }

      const data = await r.json();
      metaEl.textContent = `child_word_id ${data.child_word_id} • lang_word_id ${data.lang_word_id} • lang ${data.lang_id}`;
      childEl.textContent = data.child_word || "—";
      langNameEl.textContent = data.lang_name || "—";

      if (data.lang_word_version_id) {
        langWordLink.textContent = data.lang_word || "—";
        langWordLink.href = `lang_word.html?id=${encodeURIComponent(data.lang_word_version_id)}`;
      } else {
        langWordLink.textContent = data.lang_word || "—";
        langWordLink.removeAttribute("href");
      }
    }

    function renderTasks(tasks) {
      if (!tasks || !tasks.length) {
        tasksEl.innerHTML = '<div class="muted">none</div>';
        return;
      }
      tasksEl.innerHTML = tasks.map(t => {
        const err = t.error ? `<div class="muted" style="margin-top:.35rem;">error: ${esc(t.error)}</div>` : "";
        return `
          <div class="card">
            <div class="row" style="justify-content:space-between;">
              <div><strong>${esc(t.task_type)}</strong></div>
              <div class="muted">${esc(t.status)} • #${esc(t.id)}</div>
            </div>
            <div class="muted">updated ${esc(t.updated_at || "")}</div>
            ${err}
          </div>
        `;
      }).join("");
    }

    function renderItems(items) {
      if (!items || !items.length) {
        itemsEl.innerHTML = '<div class="muted">none</div>';
        return;
      }
      itemsEl.innerHTML = items.map(it => {
        const mod = (it.modifier || "").trim();
        return `
          <div class="card">
            <div class="row" style="justify-content:space-between;">
              <div><strong>${esc(it.prompt_type)}</strong></div>
              <div class="muted">#${esc(it.id)} • ${esc(it.updated_at || it.created_at || "")}</div>
            </div>
            <div class="muted">${mod ? "modifier: " + esc(mod) : "modifier: —"}${it.model ? " • model: " + esc(it.model) : ""}${it.task_id ? " • task: #" + esc(it.task_id) : ""}</div>
            <pre>${esc(it.text || "")}</pre>
          </div>
        `;
      }).join("");
    }

    async function loadStarStuff() {
      if (!childWordId) return;

      const r = await fetch(`/api/star_stuff?child_word_id=${encodeURIComponent(childWordId)}`, {
        headers: { "Accept": "application/json" }
      });
      if (!r.ok) {
        const err = await r.json().catch(() => ({}));
        tasksEl.innerHTML = "";
        itemsEl.innerHTML = `<div class="muted">${esc(err.error || "failed to load")}</div>`;
        return;
      }
      const data = await r.json();
      renderTasks(data.tasks || []);
      renderItems(data.items || []);
    }

    function selectedPrompts() {
      return Array.from(document.querySelectorAll('#prompt-checks input[type="checkbox"]'))
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    }

    queueBtn.addEventListener("click", async () => {
      const prompts = selectedPrompts();
      if (!prompts.length) return alert("Select at least one prompt.");

      const key = getAdminKey();
      if (!key) return alert("Enter admin key first.");

      queueBtn.disabled = true;
      queueStatusEl.textContent = "queueing…";

      try {
        const r = await fetch("/api/star_stuff/create", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json",
            "X-Admin-Key": key
          },
          body: JSON.stringify({
            child_word_id: Number(childWordId),
            prompts,
            modifier: modifierEl.value || ""
          })
        });

        const data = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(data.error || `request failed (${r.status})`);

        queueStatusEl.textContent = `queued ${data.task_ids?.length || 0}`;
        await loadStarStuff();
      } catch (e) {
        queueStatusEl.textContent = "";
        alert(e.message || String(e));
      } finally {
        queueBtn.disabled = false;
      }
    });

    refreshBtn.addEventListener("click", async () => {
      await loadStarStuff();
    });

    // init
    setAdminUI();
    loadStar().then(loadStarStuff);
  </script>
</body>
</html>
