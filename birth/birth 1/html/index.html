<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JSON Tree Viewer</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    header { margin-bottom: 12px; }
    .meta { color: #555; font-size: 0.95rem; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .box { border: 1px solid #e5e5e5; border-radius: 10px; padding: 12px; }
    details { margin-left: 14px; }
    summary { cursor: pointer; }
    .node { padding: 2px 0; }
    .pill {
      display: inline-block; padding: 0 8px; border: 1px solid #ddd; border-radius: 999px;
      font-size: 12px; color: #444; margin-left: 6px;
    }
    code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
    .error { color: #b00020; white-space: pre-wrap; }
    .hint { color:#666; font-size: 0.9rem; }
  </style>
</head>
<body>
  <header>
    <h2 style="margin:0 0 6px;">JSON Tree Viewer</h2>
    <div class="row box">
      <div>
        <label>
          <strong>Upload JSON:</strong>
          <input id="fileInput" type="file" accept="application/json,.json" />
        </label>
        <div class="hint">Expected shape: <code>{ exported_at, roots: [...] }</code></div>
      </div>
      <button id="loadExample" type="button">Load example</button>
      <button id="clear" type="button">Clear</button>
    </div>
    <div class="meta" style="margin-top:10px;">Exported at: <code id="exportedAt">—</code></div>
    <div id="status" class="meta"></div>
    <div id="error" class="error"></div>
  </header>

  <main id="tree" class="box"></main>

  <script>
    const fileInput = document.getElementById("fileInput");
    const treeEl = document.getElementById("tree");
    const exportedAtEl = document.getElementById("exportedAt");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");

    const exampleData = {
      "exported_at": "2026-01-01T00:00:00Z",
      "roots": [
        {
          "id": 1,
          "name": "English",
          "type": "lang",
          "parent_writing_id": null,
          "children": [
            {
              "id": 10,
              "name": "Verb Rules",
              "type": "grammar",
              "parent_writing_id": 1,
              "children": [
                {
                  "id": 25,
                  "name": "Irregular Verbs",
                  "parent_writing_id": 10,
                  "children": []
                }
              ]
            }
          ]
        }
      ]
    };

    // ---------- Rendering ----------
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, c => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[c]));
    }

    function nodeLabel(node) {
      const name = node?.name ?? "(unnamed)";
      const id = node?.id ?? "—";
      const type = node?.type ? `<span class="pill">${escapeHtml(node.type)}</span>` : "";
      return `<span class="node"><strong>${escapeHtml(name)}</strong> <span class="meta">#${escapeHtml(id)}</span>${type}</span>`;
    }

    function renderNode(node) {
      const children = Array.isArray(node?.children) ? node.children : [];

      if (children.length === 0) {
        const div = document.createElement("div");
        div.innerHTML = nodeLabel(node);
        return div;
      }

      const details = document.createElement("details");
      details.open = true;

      const summary = document.createElement("summary");
      summary.innerHTML = nodeLabel(node);
      details.appendChild(summary);

      for (const child of children) details.appendChild(renderNode(child));
      return details;
    }

    function renderTree(data) {
      treeEl.innerHTML = "";
      errorEl.textContent = "";
      statusEl.textContent = "";

      // Minimal validation
      if (!data || typeof data !== "object") throw new Error("Top-level JSON must be an object.");
      if (!Array.isArray(data.roots)) throw new Error('Expected "roots" to be an array.');
      exportedAtEl.textContent = data.exported_at ?? "—";

      if (data.roots.length === 0) {
        treeEl.textContent = "No roots to display.";
        return;
      }

      for (const root of data.roots) treeEl.appendChild(renderNode(root));
      statusEl.textContent = `Loaded ${data.roots.length} root node(s).`;
    }

    // ---------- File upload ----------
    async function readJsonFile(file) {
      const text = await file.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        throw new Error("Invalid JSON: " + e.message);
      }
    }

    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      try {
        statusEl.textContent = `Reading: ${file.name}`;
        const data = await readJsonFile(file);
        renderTree(data);
      } catch (err) {
        treeEl.innerHTML = "";
        exportedAtEl.textContent = "—";
        statusEl.textContent = "";
        errorEl.textContent = err.message || String(err);
      }
    });

    // ---------- Buttons ----------
    document.getElementById("loadExample").addEventListener("click", () => {
      try { renderTree(exampleData); }
      catch (err) { errorEl.textContent = err.message || String(err); }
    });

    document.getElementById("clear").addEventListener("click", () => {
      fileInput.value = "";
      treeEl.innerHTML = "";
      exportedAtEl.textContent = "—";
      statusEl.textContent = "";
      errorEl.textContent = "";
    });

    // Start empty
    treeEl.textContent = "Upload a JSON file to display its tree.";
  </script>
</body>
</html>
